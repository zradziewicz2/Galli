<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GALLIVANT — Sites & Tours</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.browser.print/dist/leaflet.browser.print.min.js"></script>

  <style>
    :root{
      --bg:#f7f8fa; --panel:#ffffff; --ink:#0f172a; --muted:#6b7280; --ring:#d1d5db;
      --brand:#00cfd4; --accent:#00cfd4;
      --radius:18px; --shadow:0 2px 12px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit}
    .wrap{max-width:1220px;margin:0 auto;padding:18px}

    /* Header / Nav */
    header{display:grid;grid-template-columns:auto 1fr auto;gap:18px;align-items:center;margin-bottom:8px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.05em}
    .logo{width:34px;height:34px;border-radius:12px;background:var(--brand);transform:rotate(18deg)}
    .top{display:flex;justify-content:center}
    .search{width:min(520px,100%);padding:10px 14px;border:1px solid var(--ring);border-radius:999px;background:#fff}
    .links{display:flex;gap:14px}
    .pill{border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;font-weight:600;text-decoration:none}

    /* Tabs */
    .tabs{display:flex;gap:26px;justify-content:center;margin:6px 0 12px}
    .tab{font-weight:800;letter-spacing:.08em;color:#111;opacity:.6;cursor:pointer;border:none;background:none;font-size:16px}
    .tab.active{opacity:1;text-decoration:underline;text-underline-offset:6px}

    /* Layout */
    .layout{display:grid;grid-template-columns:300px 1fr;gap:18px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}.sidebar{order:2}}

    /* Sidebar + Filters */
    .sidebar .panel{background:var(--panel);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .sidebar h3{margin:2px 0 10px;font-size:14px;text-transform:uppercase;letter-spacing:.1em}
    .view-map{
      display:flex;align-items:center;gap:12px;width:100%;padding:14px;background:#fff;border:1px solid var(--ring);
      border-radius:var(--radius);box-shadow:var(--shadow);color:inherit;font-weight:700;margin-bottom:14px
    }
    .view-map .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;background:#eafffb;color:#0b3a68;font-size:18px}
    .filters .group{margin-bottom:14px}
    .filters label{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:14px}
    .filters input[type="checkbox"]{width:16px;height:16px}
    details summary{cursor:pointer;color:#0b3a68;font-weight:700}

    /* Cards grid */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}

    /* Card */
    .card{position:relative;background:var(--panel);border:1px solid var(--ring);border-radius:20px;overflow:hidden;box-shadow:var(--shadow)}
    .badge{position:absolute;top:8px;left:8px;background:#111;color:#fff;font-size:10px;padding:3px 7px;border-radius:999px}
    .fav{position:absolute;top:8px;right:8px;width:30px;height:30px;border-radius:999px;display:grid;place-items:center;border:1px solid var(--ring);background:rgba(255,255,255,.9);cursor:pointer}
    .fav svg{width:16px;height:16px;fill:none;stroke:var(--accent);stroke-width:2}
    .fav.active svg{fill:var(--accent)}
    .img{width:100%;height:148px;object-fit:cover;border-bottom:1px solid var(--ring)}
    .inner{padding:12px 14px 14px}
    .title{font-size:18px;font-weight:800;margin:2px 0 4px}
    .meta{font-size:12px;color:#4b5563;margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap}
    .chipbar{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-flex;align-items:center;border:1px solid var(--ring);background:#f1f5f9;font-size:11px;border-radius:999px;padding:2px 6px}
    .chip.hit{font-weight:800;border-color:#b6fff8;background:#e6fffd}

    /* Cost badge */
    .cost-badge{display:inline-flex;align-items:center;gap:4px;border:1px solid var(--ring);padding:0 6px;border-radius:8px;font-weight:700}
    .cost-badge.free{color:#059669;border-color:#bbf7d0;background:#ecfdf5}

    /* More Info */
    .more{margin-top:6px}
    .more summary{font-size:12px;color:#0b3a68;cursor:pointer;display:inline-flex;align-items:center;gap:6px;user-select:none}
    .more summary::marker{content:''}
    .more summary span{border-bottom:1px dotted #0b3a68}
    .more[open] summary span{border-bottom-style:solid}
    .more-body{margin-top:6px}
    .desc{font-size:13px;color:#334155;line-height:1.35;margin:0}
    .icons{display:flex;gap:10px;margin-top:6px;color:#607085}
    .icons a{display:inline-flex;align-items:center;gap:6px;text-decoration:none;font-size:12px}

    /* Stats table */
    .stats{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;color:#334155}
    .stats th{font-weight:600;text-align:left;padding:6px 0;width:52%}
    .stats td{padding:6px 0}
    .stats tr+tr th, .stats tr+tr td{border-top:1px dashed #e5e7eb}

    /* Toolbar (sorting) */
    .toolbar{display:flex;align-items:center;gap:10px;justify-content:flex-end;margin-bottom:10px}
    .select{border:1px solid var(--ring);border-radius:10px;padding:6px 10px;background:#fff;font-size:12px}

    /* Overlays */
    #mapPanel,#favoritesPanel,#ourDataPanel{position:fixed;inset:0;background:#fff;display:none;z-index:1000}
    .overlayHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--ring)}
    .btn{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}

    /* Map overlay layout */
    .mapLayout{display:grid;grid-template-columns:320px 1fr;gap:16px;height:calc(100vh - 56px)}
    .mapSidebar{padding:14px;border-right:1px solid var(--ring);overflow:auto}
    .mapCanvas{position:relative}
    #map{position:absolute;inset:0}
    .legend{position:absolute;bottom:16px;right:16px;background:#fff;border:1px solid var(--ring);border-radius:12px;box-shadow:var(--shadow);padding:8px 10px;font-size:12px}

    /* Leaflet popup like a card */
    .leaflet-popup-content { margin:0; }
    .leaflet-popup-content-wrapper { padding:0; border-radius:20px; overflow:hidden; border:1px solid var(--ring); box-shadow:var(--shadow); }
    .leaflet-popup-tip { display:none; }
    .leaflet-popup .fav { pointer-events:auto; }
    .popup-card .img{ height:148px; }

    /* Our Data */
    .dataBody{padding:16px;max-width:900px;margin:0 auto;}
    .dataBody p{margin:0 0 12px;color:#334155;line-height:1.45;}
    .actionRow{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;}
    .actionRow .btn{display:inline-flex;align-items:center;gap:8px;text-decoration:none;}

    /* Footer */
    footer{max-width:1220px;margin:24px auto 40px;padding:0 18px;color:#6b7280;font-size:12px}
    .footer-links{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
    .footer-links a{color:#0b3a68;text-decoration:underline; text-underline-offset:3px}

    /* ===== Favorites / Trips ===== */
    #favoritesPanel{ display:flex; flex-direction:column; }
    .fav-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .fav-toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 14px}
    .btn.small{padding:6px 10px;font-size:12px}

    .fav-columns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      padding:14px;
      flex:1;
      min-height:0;
    }
    .fav-left, .fav-right{ min-height:0; }
    .fav-left{ overflow:auto; }
    .fav-right .mapBox{ height:100%; }
    #favoritesMap{ height:100%; }

    .favlist{display:flex;flex-direction:column;gap:10px}
    .fav-item{display:grid;grid-template-columns:84px 1fr auto;gap:12px;align-items:center;border:1px solid var(--ring);border-radius:14px;background:#fff;box-shadow:var(--shadow);padding:8px}
    .fav-thumb{width:84px;height:64px;border-radius:10px;object-fit:cover;border:1px solid var(--ring)}
    .fav-title{font-weight:800;margin:0 0 4px 0}
    .fav-meta{font-size:12px;color:#6b7280;display:flex;gap:8px;flex-wrap:wrap}
    .fav-acts{display:flex;gap:8px}
    .fav-acts .x{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
    .fav-acts .danger{border-color:#fecaca;color:#b91c1c;background:#fff0f0}

    .fav-picker{ margin-top:16px; }
    .fav-picker > summary{ cursor:pointer; font-weight:600; color:#0b3a68; }

    .itin-box{margin-top:14px;border:1px dashed var(--ring);border-radius:12px;padding:12px;background:#f8fafc}
    .itin-box textarea{width:100%;min-height:140px;border:1px solid var(--ring);border-radius:12px;padding:10px;font-family:inherit}
    .mini{font-size:12px;color:#6b7280}

    @media (max-width: 900px){
      .fav-columns{ grid-template-columns:1fr; }
      .fav-right{ height:50vh; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div> GALLIVANT</div>
      <div class="top"><input id="cityInput" class="search" placeholder="CITY" aria-label="City" /></div>
      <nav class="links">
        <a class="pill" href="#" id="myPlacesLink">MY PLACES</a>
        <a class="pill" href="#">NEW SITE SUBMISSION</a>
        <a class="pill" href="#">CONNECT</a>
      </nav>
    </header>

    <div class="tabs" role="tablist" aria-label="Content tabs">
      <button class="tab active" data-tab="all" role="tab" aria-selected="true">ALL</button>
      <button class="tab" data-tab="site" role="tab">SITES</button>
      <button class="tab" data-tab="tour" role="tab">TOURS</button>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <button class="view-map" id="viewMap"><span class="icon">🌐</span><strong>View in map</strong></button>

        <div class="panel filters" id="filtersPanelMain">
          <div class="group">
            <h3>Site Type</h3>
            <div id="siteTypeFiltersMain"></div>
          </div>
          <div class="group">
            <h3>Time Period</h3>
            <div id="periodFiltersMain"></div>
          </div>
          <details class="group" open>
            <summary>More Filters</summary>
            <div style="margin-top:8px" id="moreFiltersMain"></div>
          </details>
        </div>
      </aside>

      <main>
        <div class="toolbar">
          <label for="sortSelect" class="muted">Sort:</label>
          <select id="sortSelect" class="select" aria-label="Sort results">
            <option value="best">Best match</option>
            <option value="closest">Closest</option>
            <option value="cheapest">Cheapest</option>
            <option value="theme">Theme</option>
          </select>
        </div>

        <section id="cards" class="grid" aria-live="polite"></section>
      </main>
    </div>
  </div>

  <!-- Map Overlay -->
  <section id="mapPanel" aria-hidden="true" role="dialog" aria-label="Map view of sites + tours">
    <div class="overlayHeader">
      <strong>GALLIVANT Map</strong>
      <div>
        <button id="mapShowAll" class="btn" title="Ignore filters temporarily">Show all</button>
        <button id="closeMap" class="btn">Back to list</button>
      </div>
    </div>

    <div class="mapLayout">
      <aside class="mapSidebar">
        <div class="panel filters" id="filtersPanelMap">
          <div class="group">
            <h3>Site Type</h3>
            <div id="siteTypeFiltersMap"></div>
          </div>
          <div class="group">
            <h3>Time Period</h3>
            <div id="periodFiltersMap"></div>
          </div>
          <details class="group" open>
            <summary>More Filters</summary>
            <div style="margin-top:8px" id="moreFiltersMap"></div>
          </details>
        </div>
      </aside>

      <div class="mapCanvas">
        <div id="map"></div>
        <div class="legend" id="mapLegend"></div>
      </div>
    </div>
  </section>

  <!-- Favorites / Trips -->
  <section id="favoritesPanel" aria-hidden="true" role="dialog" aria-label="My Places">
    <div class="overlayHeader">
      <strong>My Places</strong>
      <div class="fav-actions">
        <button id="btnExportPDF" class="btn small">Export Map as PDF</button>
        <button id="btnGenerateItin" class="btn small">Generate Draft Itinerary</button>
        <button id="btnImportFavs" class="btn small">Add All Favorites to Trip</button>
        <button id="clearFavorites" class="btn small">Clear all</button>
        <button id="closeFavorites" class="btn small">Back to list</button>
      </div>
    </div>

    <div class="fav-toolbar">
      <span class="mini">Trip:</span>
      <select id="tripSelect" class="select" aria-label="Select trip"></select>
      <button id="tripAdd" class="btn small">New</button>
      <button id="tripRename" class="btn small">Rename</button>
      <button id="tripDelete" class="btn small danger">Delete</button>
    </div>

    <div class="fav-columns">
      <div class="fav-left">
        <div id="favoritesList" class="favlist" aria-live="polite"></div>

        <details id="favoritesPicker" class="fav-picker">
          <summary>Add places from your Favorites</summary>
          <div id="favoritesPool" class="favlist"></div>
        </details>

        <div id="itinBox" class="itin-box" style="display:none">
          <div class="mini" style="margin-bottom:6px">Draft itinerary (editable):</div>
          <textarea id="itinText" placeholder="Your itinerary will appear here…"></textarea>
        </div>
      </div>

      <div class="fav-right">
        <div class="mapBox"><div id="favoritesMap"></div></div>
      </div>
    </div>
  </section>

  <!-- Our Data -->
  <section id="ourDataPanel" aria-hidden="true" role="dialog" aria-label="About our data">
    <div class="overlayHeader">
      <strong>Our Data</strong>
      <div>
        <button id="closeOurData" class="btn">Back to list</button>
      </div>
    </div>
    <div class="dataBody">
      <p><strong>Gallivant is a community resource.</strong> We rely on contributors and visitors to help keep details accurate - such as hours, prices, accessibility, and management operations. If you spot anything that looks off, please let us know so we can keep this resource accurate for everyone.</p>
      <div class="actionRow">
        <a id="suggestEditBtn" class="btn" href="#" title="Suggest an edit">✏️ <span>Suggest an Edit</span></a>
        <a id="newSiteBtn" class="btn" href="#" title="Submit a new site">➕ <span>New Site Submission</span></a>
      </div>
    </div>
  </section>

  <!-- Card template -->
  <template id="cardTemplate">
    <article class="card">
      <span class="badge"></span>
      <button class="fav" title="Save to My Places" aria-label="Save"><svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.65-7 10-7 10z"/></svg></button>
      <img class="img" alt="" />
      <div class="inner">
        <h3 class="title"></h3>
        <div class="meta"></div>
        <div class="chipbar"></div>
        <details class="more">
          <summary><span>More Info</span></summary>
          <div class="more-body">
            <div class="icons"></div>
            <p class="desc"></p>
          </div>
        </details>
      </div>
    </article>
  </template>

  <footer>
    <div><strong>Our Data</strong> — We rely on our community to keep GALLIVANT accurate.</div>
    <div class="footer-links">
      <a href="#" id="footerNewSite">New Site Submission</a>
      <a href="#" id="footerCorrection">Submit Correction</a>
    </div>
  </footer>

  <script>
  (function(){
    /* ========= Label Maps ========= */
    const CATEGORY_LABELS = {
      generalhistory:'General History', localhistory:'Local History', indigenous:'Indigenous History',
      militaryhistory:'Military History', civilrights:'Civil Rights', industrialhistory:'Industrial History',
      architecturalhistory:'Architectural History', artsandculture:'Arts & Culture', religious:'Religious',
      naturalhistory:'Natural History', technologyandtransportation:'Science & Technology', historichomes:'Historic Homes',
      foodanddrink:'Food & Drink', other:'Other'
    };
    const PERIOD_LABELS = {
      prehistoric:'Prehistoric', colonial:'18th Century', eighteenthcentury:'18th Century', nineteenthcentury:'19th Century',
      twentiethcentury:'20th Century', industrialrevolution:'Industrial Era', modernhistory:'Modern History',
      indigenous:'Indigenous', other:'Other'
    };
    const SITETYPE_LABELS = {
      museums:'Museum', museum:'Museum', landmark:'Landmark', historichome:'Historical Home', historichomes:'Historical Home',
      archaeological:'Archaeological', archeological:'Archaeological', burial:'Burial', religious:'Religious',
      political:'Political', industrial:'Industrial', other:'Outdoor'
    };

    const MORE_FILTERS = {
      spanishtranslations: 'Spanish translations',
      paymentmethod: 'Cash/Credit',
      luggagestorage: 'Luggage storage',
      hiddengem: 'Hidden gem',
      featured: 'Featured site',
      publicaccess: 'Public access',
      dogfriendly: 'Pet-friendly',
      family_friendly: 'Family-friendly',
      giftshop: 'Gift shop',
      foodbeverage: 'Food & beverage on-site',
      transit_accessible: 'Accessible by public transit',
      adaaccessibility: 'ADA accessibility'
    };

    /* ========= State & Persistence ========= */
    const state = {
      rawSites: [], rawTours: [], items: [],
      tab: 'all',
      favorites: new Set(safeParse(localStorage.getItem('traipse:favorites'), [])),
      city: '', geoloc: null,
      filters: { siteTypes:new Set(), periods:new Set(), tags:new Set() },
      sort: localStorage.getItem('traipse:sort') || 'best',
      trips: safeParse(localStorage.getItem('traipse:trips'), null) || { activeId: 'default', lists: { default: { name: 'My Trip', items: [] } } },
      notes: safeParse(localStorage.getItem('traipse:notes'), {})
    };

    function safeParse(json, fallback){
      try{ return JSON.parse(json ?? ''); } catch { return fallback; }
    }

    function saveTrips(){ localStorage.setItem('traipse:trips', JSON.stringify(state.trips)); }
    function ensurePersistence(){
      if (!(state.favorites instanceof Set)) {
        state.favorites = new Set(safeParse(localStorage.getItem('traipse:favorites'), []));
      }
      if (!state.trips || !state.trips.lists) {
        state.trips = { activeId:'default', lists: { default:{ name:'My Trip', items:[] } } };
        saveTrips();
      }
      if (!state.trips.activeId || !state.trips.lists[state.trips.activeId]){
        state.trips.activeId = 'default';
        if (!state.trips.lists.default) state.trips.lists.default = { name:'My Trip', items:[] };
        saveTrips();
      }
    }

    /* ========= Utilities ========= */
    const resolveImage = (p)=> !p ? '' : (/^https?:\/\//i.test(p) ? p : (p.startsWith('./')||p.startsWith('images/') ? p : `images/${p}`));
    function haversine(a, b){
      const toRad=d=>d*Math.PI/180, R=6371;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));
    }
    const kmToMiles = km => km*0.621371;
    const formatMiles = m => !isFinite(m) ? '' : (m<0.2? `${(m*5280).toFixed(0)} ft away` : (m<10? `${m.toFixed(1)} mi away` : `${Math.round(m)} mi away`));
    function costRank(it){
      const c = (it.costText || it.raw?.Cost || '').toString().trim().toLowerCase();
      if(!c) return 999;
      if(c.includes('free') || c==='$0' || c==='0') return 0;
      const dollarMatch = c.match(/\${1,4}/); if(dollarMatch) return dollarMatch[0].length;
      const num = parseFloat(c.replace(/[^0-9.]/g,'')); return isNaN(num) ? 999 : num;
    }
    function distanceFromUser(it){
      if(!state.geoloc) return Infinity;
      let target=null;
      if(it.type==='Tour' && it.center) target = it.center;
      else {
        const {lat,lng}=it.raw||{};
        if(typeof lat==='number' && typeof lng==='number') target={lat,lng};
      }
      if(!target) return Infinity;
      return kmToMiles(haversine(state.geoloc, target));
    }

    /* ========= Normalization ========= */
    function normalizeSite(raw){
      const periods = (raw.timeperiod||[]).map(p => PERIOD_LABELS[p]||p);
      const siteTypeSlug = (raw.sitetype||'').toLowerCase();
      const siteType = SITETYPE_LABELS[siteTypeSlug] || (raw.type==='outdoor' ? 'Outdoor' : SITETYPE_LABELS.other);
      return {
        id: raw.id || (raw.name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-'),
        name: raw.name,
        type: 'Site',
        image: raw.image,
        website: raw.website && raw.website!=='notavailable' ? raw.website : '',
        categories: (raw.thematiccategory||[]).map(c => CATEGORY_LABELS[c]||c),
        siteType,
        periods,
        description: raw.description||'',
        costText: raw.dollaramount && !['0','$0','-'].includes(String(raw.dollaramount).trim()) ? String(raw.dollaramount) : (raw.cost==='free'?'Free': (raw.cost==='paid'?'Paid':'')),
        durationText: raw.estimatedtime || '',
        city: (raw.city||'').toLowerCase(),
        raw
      };
    }
    function normalizeTour(raw){
      let center=null;
      if(Array.isArray(raw.route) && raw.route.length){
        const lat = raw.route.reduce((a,b)=>a+b.lat,0)/raw.route.length;
        const lng = raw.route.reduce((a,b)=>a+b.lng,0)/raw.route.length;
        center = {lat,lng};
      }else if(Array.isArray(raw.sites) && raw.sites.length){
        center = {lat: raw.sites[0].lat, lng: raw.sites[0].lng};
      }
      return {
        id: raw.tour_id || (raw.tour_name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-'),
        name: raw.tour_name,
        type: 'Tour',
        image: raw.image,
        website: '',
        categories: [CATEGORY_LABELS[raw.thematiccategory]||raw.thematiccategory||'General'],
        siteType: 'Tour',
        periods: [],
        description: `${raw.duration||''} • ${raw.Cost||''}`.trim(),
        durationText: raw.duration || '',
        color: '#e11d48',
        center,
        raw
      };
    }

    /* ========= Filters UI ========= */
    function hasTag(it, key){
      const r = it.raw||{};
      switch(key){
        case 'paymentmethod': return (r.paymentmethod||'').toLowerCase()==='both';
        case 'hiddengem': return !!r.hiddenGem;
        case 'foodbeverage': return !!(r.diningonsite || r.diningonsite2);
        case 'transit_accessible': return (r.transit||'').toLowerCase()==='underhalfamilefromtransit';
        case 'spanishtranslations': return !!r.spanishtranslations;
        case 'luggagestorage': return !!r.luggagestorage;
        case 'featured': return !!r.featured;
        case 'publicaccess': return !!r.publicaccess;
        case 'dogfriendly': return !!r.dogfriendly;
        case 'family_friendly': return !!r.family_friendly;
        case 'giftshop': return !!r.giftshop;
        case 'adaaccessibility': return !!r.adaaccessibility;
        default: return !!r[key];
      }
    }
    function scoreMatches(it){
      let score=0;
      if(state.filters.siteTypes.size && state.filters.siteTypes.has(it.siteType)) score++;
      if(state.filters.periods.size) (it.periods||[]).forEach(p=>{ if(state.filters.periods.has(p)) score++; });
      if(state.filters.tags.size) for(const key of state.filters.tags){ if(hasTag(it,key)) score++; }
      return score;
    }
    function addCheckbox(wrap, bucket, value, label){
      const id = `${bucket}-${value.replace(/[^a-z0-9]+/gi,'-')}-${wrap.id}`;
      const el = document.createElement('label');
      el.innerHTML = `<input type="checkbox" id="${id}"> <span>${label}</span>`;
      const input = el.querySelector('input');
      input.addEventListener('change', ()=>{
        const set = state.filters[bucket];
        if(input.checked) set.add(value); else set.delete(value);
        const source = wrap.id.endsWith('Map') ? 'map' : 'main';
        syncFilterUIs(source);
        render();
      });
      wrap.appendChild(el);
    }
    function buildFilters(target){
      const items = state.items;
      const siteTypes = Array.from(new Set(items.map(i=>i.siteType).filter(Boolean))).filter(t=>t!=='Tour').sort();
      const periodsSet = new Set(); items.forEach(i=> (i.periods||[]).forEach(p=>periodsSet.add(p)));
      const periods = Array.from(periodsSet).sort();

      const siteWrap = document.getElementById(`siteTypeFilters${target}`);
      const perWrap  = document.getElementById(`periodFilters${target}`);
      const moreWrap = document.getElementById(`moreFilters${target}`);
      siteWrap.innerHTML = perWrap.innerHTML = moreWrap.innerHTML = '';

      siteTypes.forEach(label=>addCheckbox(siteWrap,'siteTypes',label,label));
      periods.forEach(p=>addCheckbox(perWrap,'periods',p,p));
      Object.entries(MORE_FILTERS).forEach(([k,v])=>addCheckbox(moreWrap,'tags',k,v));
    }
    function syncFilterUIs(source){
      const main = document.getElementById('filtersPanelMain');
      const mapP = document.getElementById('filtersPanelMap');
      const getCheckedWithLabels = (panel)=>{
        const res=new Set();
        panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
          const label = cb.nextElementSibling?.textContent?.trim();
          if(cb.checked && label) res.add(label);
        });
        return res;
      };
      const setToByLabels = (panel, selected)=>{
        panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
          const label = cb.nextElementSibling?.textContent?.trim();
          cb.checked = selected.has(label);
        });
      };
      if(source==='map') setToByLabels(main, getCheckedWithLabels(mapP));
      else setToByLabels(mapP, getCheckedWithLabels(main));
    }

    /* ========= Cards ========= */
    function costBadgeHTML(it){
      const c=(it.costText || it.raw?.Cost || '').toString().trim();
      if(!c) return '';
      const free = /free|\$?0\b/i.test(c);
      return `<span class="cost-badge ${free?'free':''}">${free?'FREE':c}</span>`;
    }
    function buildStatsTableHTML(it){
      const r=it.raw||{};
      const yesNo = v => v===undefined || v===null ? '—' : (v ? 'Yes' : 'No');
      const foodOnsite = !!(r.diningonsite || r.diningonsite2);
      const transitOk  = (r.transit||'').toLowerCase()==='underhalfamilefromtransit';
      const payMethod  = (r.paymentmethod||'').toLowerCase()==='both' ? 'Cash & credit' :
                         (r.paymentmethod||'') ? String(r.paymentmethod) : '—';
      const rowsSite = [
        ['Hours', r.hours||'—'],
        ['Cost', it.costText || '—'],
        ['Duration', it.durationText || '—'],
        ['Pet-friendly', yesNo(r.dogfriendly)],
        ['Family-friendly', yesNo(r.family_friendly)],
        ['Gift shop', yesNo(r.giftshop)],
        ['Food & beverage on-site', yesNo(foodOnsite)],
        ['Accessible by public transit', yesNo(transitOk)],
        ['ADA accessibility', yesNo(r.adaaccessibility)],
        ['Luggage storage', yesNo(r.luggagestorage)],
        ['Spanish translations', yesNo(r.spanishtranslations)],
        ['Public access', yesNo(r.publicaccess)],
        ['Payment method', payMethod]
      ];
      const rowsTour = [
        ['Duration', it.durationText || '—'],
        ['# of sites', r.number_of_sites || '—'],
        ['Cost', r.Cost || r.cost_range?.join(' - ') || '—'],
        ['Reservation required', yesNo(r.reservation_required)],
        ['Seasonal', yesNo(r.seasonal)],
        ['Group type', r.group_type || '—']
      ];
      const rows = it.type==='Tour' ? rowsTour : rowsSite;
      const tr = rows.map(([k,v])=>`<tr><th>${k}</th><td>${v}</td></tr>`).join('');
      return `<table class="stats" aria-label="Details"><tbody>${tr}</tbody></table>`;
    }
    function filterChips(it){
      const chips=[];
      if(state.filters.siteTypes.size && state.filters.siteTypes.has(it.siteType)) chips.push(it.siteType);
      if(state.filters.periods.size) (it.periods||[]).forEach(p=>{ if(state.filters.periods.has(p)) chips.push(p); });
      if(state.filters.tags.size) Object.entries(MORE_FILTERS).forEach(([k,label])=>{ if(state.filters.tags.has(k) && hasTag(it,k)) chips.push(label); });
      return chips;
    }
    function buildCardNode(it, score, distMiles){
      const tpl = document.getElementById('cardTemplate');
      const node = tpl.content.cloneNode(true);
      const root = node.querySelector('.card');
      root.id = 'card-'+it.id;

      node.querySelector('.badge').textContent = it.type || 'Site';

      const fav = node.querySelector('.fav');
      fav.dataset.id = it.id;
      if(state.favorites.has(it.id)) fav.classList.add('active');
      fav.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFavorite(it.id); });

      const img = node.querySelector('.img');
      const requested = resolveImage(it.image);
      img.src = requested || 'images/default.jpg';
      img.alt = `${it.name} image`;
      img.onerror = ()=>{ img.src = 'images/default.jpg'; };

      node.querySelector('.title').textContent = it.name;

      const metaBits=[];
      const costBadge = costBadgeHTML(it);
      if(costBadge) metaBits.push(costBadge);
      if(it.categories?.length) metaBits.push(it.categories.join(', '));
      if(it.periods?.length)    metaBits.push(it.periods[0]);
      const distanceText = formatMiles(distMiles);
      if(distanceText) metaBits.push(distanceText);
      node.querySelector('.meta').innerHTML = metaBits.join(' • ');

      const chipbar = node.querySelector('.chipbar');
      const chips = filterChips(it);
      chips.forEach(c=>{ const s=document.createElement('span'); s.className='chip hit'; s.textContent=c; chipbar.appendChild(s); });

      const icons = node.querySelector('.icons');
      const links=[];
      if(it.website) links.push(`<a href="${it.website}" target="_blank" rel="noopener">🌐 <span>Website</span></a>`);
      if(it.type==='Tour' && it.raw?.external_links){
        for(const [name,url] of Object.entries(it.raw.external_links)){ links.push(`<a href="${url}" target="_blank" rel="noopener">🔗 <span>${name}</span></a>`); }
      }
      icons.innerHTML = links.join(' ');
      node.querySelector('.desc').textContent = it.description||'';

      const moreBody = root.querySelector('.more-body');
      const statsDiv = document.createElement('div');
      statsDiv.innerHTML = buildStatsTableHTML(it);
      moreBody.appendChild(statsDiv.firstElementChild);

      return node;
    }

    /* ========= Favorites / Trips ========= */
    const TYPE_COLORS = {
      'Museum':'#00cfd4','Landmark':'#00cfd4','Historical Home':'#00cfd4','Archaeological':'#00cfd4',
      'Religious':'#00cfd4','Industrial':'#00cfd4','Outdoor':'#00cfd4','Burial':'#00cfd4','Political':'#00cfd4','Tour':'#e11d48'
    };
    function siteIconFor(type){
      const color = TYPE_COLORS[type] || '#00cfd4';
      return L.divIcon({
        className:'circle-icon',
        html:`<div style="width:18px;height:18px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.12)"></div>`,
        iconSize:[22,22], iconAnchor:[11,11]
      });
    }
    function itemById(id){ return state.items.find(x=>x.id===id); }
    function addIdsToActiveTrip(ids){
      const list = state.trips.lists[state.trips.activeId]; if(!list) return 0;
      let added = 0;
      ids.forEach(id=>{
        if(!list.items.includes(id)){ list.items.push(id); added++; }
        if(!state.favorites.has(id)) state.favorites.add(id);
      });
      localStorage.setItem('traipse:favorites', JSON.stringify(Array.from(state.favorites)));
      saveTrips();
      return added;
    }
    function removeFromTrip(id){
      const list = state.trips.lists[state.trips.activeId]; if(!list) return;
      list.items = list.items.filter(x=>x!==id);
      saveTrips();
    }
    function tripItemIds(){
      const t = state.trips?.lists?.[state.trips?.activeId];
      return Array.isArray(t?.items) ? t.items.slice() : [];
    }
    function tripItems(){ return tripItemIds().map(id=>itemById(id)).filter(Boolean); }

    let favoritesOpen=false;
    let favoritesMap, favoritesMapLayer;
    function ensureFavoritesMap(){
      if (favoritesMap) return;
      favoritesMap = L.map('favoritesMap', { scrollWheelZoom:true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(favoritesMap);
      favoritesMapLayer = L.layerGroup().addTo(favoritesMap);
      if (L.control && L.control.browserPrint) L.control.browserPrint({ position:'topleft', title:'Print map' }).addTo(favoritesMap);
    }
    function renderFavoritesMap(){
      if (!favoritesMap || !favoritesMapLayer) return;
      favoritesMapLayer.clearLayers();
      const items = tripItems();
      const bounds = [];
      items.forEach(it=>{
        const r=it.raw||{}, {lat,lng}=r;
        const ll = (typeof lat==='number' && typeof lng==='number') ? [lat,lng] : (it.center ? [it.center.lat, it.center.lng] : null);
        if(!ll) return;
        const m = L.marker(ll, { icon: siteIconFor(it.siteType || it.type) }).addTo(favoritesMapLayer);
        m.bindPopup(cardHTMLForPopup(it));
        bounds.push(ll);
      });
      if(bounds.length) favoritesMap.fitBounds(bounds, { padding:[30,30] });
      else favoritesMap.setView([39.7392,-104.9903], 11);
      setTimeout(()=> favoritesMap.invalidateSize(), 60);
    }
    function cardHTMLForPopup(it){
      const chips = filterChips(it).map(c=>`<span class="chip hit">${c}</span>`).join('');
      const metaBits=[];
      const costBadge = costBadgeHTML(it);
      if(costBadge) metaBits.push(costBadge);
      if(it.categories?.length) metaBits.push(it.categories.join(', '));
      if(it.periods?.length)    metaBits.push(it.periods[0]);
      const links=[];
      if(it.website) links.push(`<a href="${it.website}" target="_blank" rel="noopener">🌐 <span>Website</span></a>`);
      if(it.type==='Tour' && it.raw?.external_links){
        for(const [name,url] of Object.entries(it.raw.external_links)){ links.push(`<a href="${url}" target="_blank" rel="noopener">🔗 <span>${name}</span></a>`); }
      }
      const openCard = `<a href="#card-${it.id}" onclick="document.getElementById('closeMap').click(); setTimeout(()=>{document.getElementById('card-${it.id}')?.scrollIntoView({behavior:'smooth',block:'start'});},150); return false;">Open card</a>`;
      const img = resolveImage(it.image) || 'images/default.jpg';
      return `
        <article class="card popup-card" id="card-${it.id}">
          <span class="badge">${it.type||'Site'}</span>
          <button class="fav${state.favorites.has(it.id)?' active':''}" aria-label="Save" data-id="${it.id}">
            <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.65-7 10-7 10z"/></svg>
          </button>
          <img class="img" src="${img}" alt="${it.name} image" onerror="this.src='images/default.jpg'"/>
          <div class="inner">
            <h3 class="title">${it.name}</h3>
            <div class="meta">${metaBits.join(' • ')}</div>
            <div class="chipbar">${chips}</div>
            <details class="more">
              <summary><span>More Info</span></summary>
              <div class="more-body">
                <div class="icons">${[...links, openCard].join(' ')}</div>
                <p class="desc">${it.description||''}</p>
                ${buildStatsTableHTML(it)}
              </div>
            </details>
          </div>
        </article>`;
    }

    function ensureTripSelect(){
      const sel = document.getElementById('tripSelect');
      if(!sel) return;
      ensurePersistence();
      sel.innerHTML='';
      Object.entries(state.trips.lists).forEach(([id,list])=>{
        const opt=document.createElement('option');
        opt.value=id; opt.textContent=list?.name || 'My Trip';
        if(id===state.trips.activeId) opt.selected=true;
        sel.appendChild(opt);
      });
      sel.onchange=()=>{ state.trips.activeId=sel.value; saveTrips(); renderFavorites(); renderFavoritesMap(); };
    }
    function renderFavorites(){
      ensurePersistence(); ensureTripSelect();
      const listEl = document.getElementById('favoritesList');
      const poolEl = document.getElementById('favoritesPool');
      const picker = document.getElementById('favoritesPicker');

      const inTrip = tripItems();
      listEl.innerHTML='';
      if(!inTrip.length){
        listEl.innerHTML = '<p class="mini">No places in this trip yet. Save places (heart icon) from the main list, then use “Add places from your Favorites” below to add them here.</p>';
      }else{
        inTrip.forEach(it=>{
          const row=document.createElement('div'); row.className='fav-item';
          const img = it.image ? it.image : 'images/default.jpg';
          row.innerHTML = `
            <img class="fav-thumb" src="${img}" onerror="this.src='images/default.jpg'" alt="">
            <div>
              <div class="fav-title">${it.name}</div>
              <div class="fav-meta">
                ${(it.type||'Site')} • ${(it.categories||[]).join(', ') || '—'}
                ${it.durationText? ' • ⏱ '+it.durationText : ''}
                ${it.costText? ' • '+it.costText : ''}
              </div>
            </div>
            <div class="fav-acts">
              <button class="x" data-act="remove" data-id="${it.id}">Remove from Trip</button>
            </div>`;
          listEl.appendChild(row);
        });
      }

      const idsInTrip = new Set(tripItemIds());
      const poolIds = Array.from(state.favorites).filter(id=>!idsInTrip.has(id));
      poolEl.innerHTML='';
      if(!poolIds.length){ if(picker) picker.open=false; }
      else{
        if(picker && !picker.hasAttribute('open')) picker.open=true;
        poolIds.map(id=>itemById(id)).filter(Boolean).forEach(it=>{
          const row=document.createElement('div'); row.className='fav-item';
          const img = it.image ? it.image : 'images/default.jpg';
          row.innerHTML=`
            <img class="fav-thumb" src="${img}" onerror="this.src='images/default.jpg'" alt="">
            <div>
              <div class="fav-title">${it.name}</div>
              <div class="fav-meta">
                ${(it.type||'Site')} • ${(it.categories||[]).join(', ') || '—'}
                ${it.durationText? ' • ⏱ '+it.durationText : ''}
                ${it.costText? ' • '+it.costText : ''}
              </div>
            </div>
            <div class="fav-acts">
              <button class="x" data-act="add" data-id="${it.id}">Add to Trip</button>
            </div>`;
          poolEl.appendChild(row);
        });
      }

      listEl.querySelectorAll('[data-act="remove"]').forEach(b=>{
        b.onclick=()=>{ removeFromTrip(b.dataset.id); renderFavorites(); renderFavoritesMap(); };
      });
      poolEl.querySelectorAll('[data-act="add"]').forEach(b=>{
        b.onclick=()=>{ addIdsToActiveTrip([b.dataset.id]); renderFavorites(); renderFavoritesMap(); };
      });
    }

    function openFavorites(){
      document.getElementById('mapPanel').style.display='none';
      document.getElementById('mapPanel').setAttribute('aria-hidden','true');
      const p=document.getElementById('favoritesPanel');
      favoritesOpen=true;
      ensurePersistence();
      ensureFavoritesMap();
      renderFavorites();
      p.style.display='block'; p.setAttribute('aria-hidden','false');
      setTimeout(()=>{ favoritesMap.invalidateSize(); renderFavoritesMap(); }, 60);
    }
    function closeFavorites(){
      favoritesOpen=false;
      const p=document.getElementById('favoritesPanel');
      p.style.display='none'; p.setAttribute('aria-hidden','true');
    }

    /* ========= Map Overlay ========= */
    let mainMap, mainLayer;
    function ensureMainMap(){
      if (mainMap) return;
      mainMap = L.map('map', { scrollWheelZoom:true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(mainMap);
      mainLayer = L.layerGroup().addTo(mainMap);
    }
    function filteredItems(){
      const tab = state.tab || 'all';
      return state.items.filter(it=>{
        if (tab==='site' && it.type!=='Site') return false;
        if (tab==='tour' && it.type!=='Tour') return false;
        if (state.filters.siteTypes.size && !state.filters.siteTypes.has(it.siteType)) return false;
        if (state.filters.periods.size){
          const p = it.periods || [];
          if (!p.some(x => state.filters.periods.has(x))) return false;
        }
        if (state.filters.tags.size){
          for (const key of state.filters.tags){ if (!hasTag(it,key)) return false; }
        }
        return true;
      });
    }
    function latlngOf(it){
      const r=it.raw||{};
      if (it.type==='Tour' && it.center) return [it.center.lat, it.center.lng];
      if (typeof r.lat==='number' && typeof r.lng==='number') return [r.lat,r.lng];
      return null;
    }
    function renderMap(showAll=false){
      ensureMainMap();
      mainLayer.clearLayers();
      const items = showAll ? state.items : filteredItems();
      const bounds=[];
      items.forEach(it=>{
        const ll = latlngOf(it); if(!ll) return;
        const m = L.marker(ll, { icon: siteIconFor(it.siteType || it.type) }).addTo(mainLayer);
        m.bindPopup(cardHTMLForPopup(it));
        bounds.push(ll);
      });
      if(bounds.length) mainMap.fitBounds(bounds, { padding:[30,30] });
      else mainMap.setView([39.7392,-104.9903], 11);
      setTimeout(()=> mainMap.invalidateSize(), 60);
    }

    /* ========= Main List Render ========= */
    function render(){
      const tab = state.tab || 'all';
      const rows=[];
      for(const it of state.items){
        if (tab==='site' && it.type!=='Site') continue;
        if (tab==='tour' && it.type!=='Tour') continue;
        if (state.filters.siteTypes.size && !state.filters.siteTypes.has(it.siteType)) continue;
        if (state.filters.periods.size){
          const p=it.periods||[]; if(!p.some(x=>state.filters.periods.has(x))) continue;
        }
        if (state.filters.tags.size){
          let ok=true; for(const key of state.filters.tags){ if(!hasTag(it,key)){ ok=false; break; } }
          if(!ok) continue;
        }
        rows.push({it, score:scoreMatches(it), dist:distanceFromUser(it), cost:costRank(it)});
      }

      const sortMode = state.sort || 'best';
      if (sortMode==='closest')      rows.sort((a,b)=> (a.dist - b.dist) || (b.score - a.score));
      else if (sortMode==='cheapest')rows.sort((a,b)=> (a.cost - b.cost) || (b.score - a.score));
      else if (sortMode==='theme')   rows.sort((a,b)=> (String(a.it.categories?.[0]||'').localeCompare(String(b.it.categories?.[0]||''))) || a.it.name.localeCompare(b.it.name));
      else                           rows.sort((a,b)=> (b.score - a.score) || (a.dist - b.dist));

      const grid=document.getElementById('cards');
      grid.innerHTML='';
      const frag=document.createDocumentFragment();
      rows.forEach(({it,score,dist})=> frag.appendChild(buildCardNode(it,score,dist)));
      grid.appendChild(frag);
    }

    /* ========= Data Load ========= */
    async function loadData(){
      try{
        const [siteRes,tourRes] = await Promise.all([
          fetch('locations.json?v='+Date.now()),
          fetch('tours.json?v='+Date.now())
        ]);
        const sites = await siteRes.json();
        const tours = await tourRes.json();

        state.rawSites = Array.isArray(sites)?sites: (sites.locations||[]);
        state.rawTours = Array.isArray(tours)?tours: (tours.tours||[]);

        const siteItems = state.rawSites.map(normalizeSite);
        const tourItems = state.rawTours.map(normalizeTour);
        state.items = [...siteItems, ...tourItems];

        buildFilters('Main');
        buildFilters('Map');
        syncFilterUIs('main');

        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(
            pos => { state.geoloc={lat:pos.coords.latitude, lng:pos.coords.longitude}; render(); },
            ()=>{ render(); },
            { enableHighAccuracy:true, timeout:7000, maximumAge:120000 }
          );
        } else {
          render();
        }
      }catch(e){
        console.error('Data load failed:', e);
        render(); // render whatever we can
      }
    }

    /* ========= Favorites & Hearts ========= */
    function toggleFavorite(id){
      const adding = !state.favorites.has(id);
      if(adding) state.favorites.add(id); else state.favorites.delete(id);
      localStorage.setItem('traipse:favorites', JSON.stringify(Array.from(state.favorites)));
      document.querySelectorAll(\`.fav[data-id="\${id}"]\`).forEach(b=>b.classList.toggle('active', state.favorites.has(id)));

      // add to current trip when saving
      if (adding){
        const list = state.trips.lists[state.trips.activeId];
        if (list && !list.items.includes(id)) { list.items.push(id); saveTrips(); }
      }
      if (favoritesOpen){ renderFavorites(); renderFavoritesMap(); }
    }
    // expose for popup inline handler search (bound via event delegation below)
    window.toggleFavorite = toggleFavorite;

    /* ========= Events ========= */
    document.addEventListener('DOMContentLoaded', ()=>{
      // Tabs
      document.querySelectorAll('.tabs .tab').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.tabs .tab').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          state.tab = btn.dataset.tab;
          render();
          // keep map in sync if open
          if(document.getElementById('mapPanel').style.display==='block') renderMap(false);
        });
      });

      // Sorting
      const sortSel=document.getElementById('sortSelect');
      sortSel.value = state.sort;
      sortSel.addEventListener('change',(e)=>{ state.sort=e.target.value; localStorage.setItem('traipse:sort', state.sort); render(); });

      // Map overlay open/close
      document.getElementById('viewMap').addEventListener('click', ()=>{
        const p=document.getElementById('mapPanel'); p.style.display='block'; p.setAttribute('aria-hidden','false');
        syncFilterUIs('main'); renderMap(false);
      });
      document.getElementById('closeMap').addEventListener('click', ()=>{
        const p=document.getElementById('mapPanel'); p.style.display='none'; p.setAttribute('aria-hidden','true');
      });
      document.getElementById('mapShowAll').addEventListener('click', ()=> renderMap(true));

      // Keep map synced with filters while open
      ['filtersPanelMain','filtersPanelMap'].forEach(id=>{
        document.getElementById(id)?.addEventListener('change', ()=>{
          const vis = document.getElementById('mapPanel')?.style.display;
          if (vis && vis !== 'none') renderMap(false);
        });
      });

      // Favorites panel open/close
      document.getElementById('myPlacesLink').addEventListener('click', (e)=>{ e.preventDefault(); openFavorites(); });
      document.getElementById('closeFavorites').addEventListener('click', (e)=>{ e.preventDefault(); closeFavorites(); });

      // Favorites actions
      document.getElementById('clearFavorites').addEventListener('click', ()=>{
        state.favorites.clear();
        localStorage.setItem('traipse:favorites','[]');
        try{ renderFavorites(); renderFavoritesMap(); }catch{}
        document.querySelectorAll('.fav').forEach(b=>b.classList.remove('active'));
      });
      document.getElementById('btnImportFavs').addEventListener('click', ()=>{
        const ids = Array.from(state.favorites);
        const added = addIdsToActiveTrip(ids);
        alert(\`Added \${added||0} item(s) to "\${state.trips.lists[state.trips.activeId].name}".\`);
        renderFavorites(); renderFavoritesMap();
      });
      document.getElementById('btnGenerateItin').addEventListener('click', ()=>{
        const box=document.getElementById('itinBox'); const txt=document.getElementById('itinText');
        box.style.display='block';
        txt.value = generateItineraryText();
      });
      document.getElementById('btnExportPDF').addEventListener('click', ()=>{
        ensureFavoritesMap();
        if(L.browserPrint) L.browserPrint({ mode:'Landscape', title:'My Places Map' }).print(favoritesMap);
        else alert('Browser print control not available.');
      });

      // Trip controls
      document.getElementById('tripAdd').addEventListener('click', ()=>{
        const name=prompt('Trip name?','New Trip'); if(!name) return;
        const id = name.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now().toString(36);
        state.trips.lists[id]={ name, items:[] }; state.trips.activeId=id; saveTrips(); ensureTripSelect(); renderFavorites(); renderFavoritesMap();
      });
      document.getElementById('tripRename').addEventListener('click', ()=>{
        const id=state.trips.activeId; const cur=state.trips.lists[id]; if(!cur) return;
        const name=prompt('Rename trip:', cur.name); if(!name) return;
        cur.name=name; saveTrips(); ensureTripSelect();
      });
      document.getElementById('tripDelete').addEventListener('click', ()=>{
        const id=state.trips.activeId;
        if(id==='default'){ alert('Cannot delete default trip.'); return; }
        if(!confirm('Delete this trip? Items remain in your Favorites.')) return;
        delete state.trips.lists[id]; state.trips.activeId='default'; saveTrips(); ensureTripSelect(); renderFavorites(); renderFavoritesMap();
      });

      // Heart toggling inside Leaflet popups (event delegation)
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('.leaflet-popup .fav');
        if (btn && btn.dataset.id) toggleFavorite(btn.dataset.id);
      });

      // Initial data load
      loadData();
    });

    /* ========= Itinerary ========= */
    function generateItineraryText(){
      const items = tripItems();
      if (!items.length) return 'No places in this trip yet.';
      return items.map((it, i)=>{
        const bits=[ `${i+1}. ${it.name}` ];
        if(it.durationText) bits.push(`⏱ ${it.durationText}`);
        if(it.costText)     bits.push(`Cost: ${it.costText}`);
        if(it.categories?.length) bits.push(it.categories.join(', '));
        return bits.join(' • ');
      }).join('\n');
    }
  })();
  </script>
</body>
</html>
