<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GALLIVANT ‚Äî Sites & Tours</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#f7f8fa; --panel:#ffffff; --ink:#0f172a; --muted:#6b7280; --ring:#d1d5db;
      /* Unified blue system */
      --brand:#2563eb; --accent:#2563eb; /* normalized blues */
      --radius:18px; --shadow:0 2px 12px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit}
    .wrap{max-width:1220px;margin:0 auto;padding:18px}

    /* Header / Nav */
    header{display:grid;grid-template-columns:auto 1fr auto;gap:18px;align-items:center;margin-bottom:8px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.05em}
    .logo{width:34px;height:34px;border-radius:12px;background:var(--brand);transform:rotate(18deg)}
    .top{display:flex;justify-content:center}
    .search{width:min(520px,100%);padding:10px 14px;border:1px solid var(--ring);border-radius:999px;background:#fff}
    .links{display:flex;gap:14px}
    .pill{border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;font-weight:600}

    /* Tabs */
    .tabs{display:flex;gap:26px;justify-content:center;margin:6px 0 12px}
    .tab{font-weight:800;letter-spacing:.08em;color:#111;opacity:.6;cursor:pointer;border:none;background:none;font-size:16px}
    .tab.active{opacity:1;text-decoration:underline;text-underline-offset:6px}

    /* Layout */
    .layout{display:grid;grid-template-columns:300px 1fr;gap:18px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}.sidebar{order:2}}

    /* Sidebar + Filters */
    .sidebar .panel{background:var(--panel);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .sidebar h3{margin:2px 0 10px;font-size:14px;text-transform:uppercase;letter-spacing:.1em}
    .view-map{
      display:flex;align-items:center;gap:12px;width:100%;padding:14px;background:#fff;border:1px solid var(--ring);
      border-radius:var(--radius);box-shadow:var(--shadow);color:inherit;font-weight:700;margin-bottom:14px
    }
    .view-map .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;background:#eaf2ff;color:#0b3a68;font-size:18px}
    .filters .group{margin-bottom:14px}
    .filters label{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:14px}
    .filters input[type="checkbox"], .filters input[type="radio"]{width:16px;height:16px}
    .filters .field{display:flex;gap:8px;align-items:center;margin:8px 0}
    .filters select,.filters input[type="text"],.filters input[type="number"]{border:1px solid var(--ring);border-radius:10px;padding:6px 8px;background:#fff}
    details summary{cursor:pointer;color:#0b3a68;font-weight:700}

    /* Cards grid ‚Äî 3 columns (wider) */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}

    /* Card */
    .card{position:relative;background:var(--panel);border:1px solid var(--ring);border-radius:20px;overflow:hidden;box-shadow:var(--shadow)}
    .badge{position:absolute;top:8px;left:8px;background:#111;color:#fff;font-size:10px;padding:3px 7px;border-radius:999px}
    .fav{position:absolute;top:8px;right:8px;width:30px;height:30px;border-radius:999px;display:grid;place-items:center;border:1px solid var(--ring);background:rgba(255,255,255,.9);cursor:pointer}
    .fav svg{width:16px;height:16px;fill:none;stroke:var(--accent);stroke-width:2}
    .fav.active svg{fill:var(--accent)}
    .img{width:100%;height:148px;object-fit:cover;border-bottom:1px solid var(--ring)}
    .inner{padding:12px 14px 14px}
    .title{font-size:18px;font-weight:800;margin:2px 0 4px}
    .meta{font-size:12px;color:#4b5563;margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap}
    .chipbar{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-flex;align-items:center;border:1px solid var(--ring);background:#f1f5f9;font-size:11px;border-radius:999px;padding:2px 6px}

    /* More Info */
    .more{margin-top:6px}
    .more summary{font-size:12px;color:#0b3a68;cursor:pointer;display:inline-flex;align-items:center;gap:6px;user-select:none}
    .more summary::marker{content:''}
    .more summary span{border-bottom:1px dotted #0b3a68}
    .more[open] summary span{border-bottom-style:solid}
    .more-body{margin-top:6px}
    .desc{font-size:13px;color:#334155;line-height:1.35;margin:0}
    .icons{display:flex;gap:10px;margin-top:6px;color:#607085}
    .icons a{display:inline-flex;align-items:center;gap:6px;text-decoration:none;font-size:12px}

    /* Stats table */
    .stats{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;color:#334155}
    .stats th{font-weight:600;text-align:left;padding:6px 0;width:52%}
    .stats td{padding:6px 0}
    .stats tr+tr th, .stats tr+tr td{border-top:1px dashed #e5e7eb}

    /* Overlays */
    #mapPanel,#favoritesPanel{position:fixed;inset:0;background:#fff;display:none;z-index:1000}
    .overlayHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--ring)}
    .btn{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}

    /* Map overlay layout */
    .mapLayout{display:grid;grid-template-columns:320px 1fr;gap:16px;height:calc(100vh - 56px)}
    .mapSidebar{padding:14px;border-right:1px solid var(--ring);overflow:auto}
    .mapCanvas{position:relative}
    #map{position:absolute;inset:0}
    .legend{position:absolute;bottom:16px;right:16px;background:#fff;border:1px solid var(--ring);border-radius:12px;box-shadow:var(--shadow);padding:8px 10px;font-size:12px}
    .legend-row{display:flex;align-items:center;gap:8px;margin:4px 0}

    /* Leaflet popup like a card */
    .leaflet-popup-content { margin:0; }
    .leaflet-popup-content-wrapper { padding:0; border-radius:20px; overflow:hidden; border:1px solid var(--ring); box-shadow:var(--shadow); }
    .leaflet-popup-tip { display:none; }
    .leaflet-popup .fav { pointer-events:auto; }
    .popup-card .img{ height:148px; }

    /* Smaller top-right pills from earlier */
    .links .pill{ font-size:12px; padding:6px 10px; }

    /* Our Data panel */
    #ourDataPanel{position:fixed;inset:0;background:#fff;display:none;z-index:1000}
    .dataBody{padding:16px;max-width:900px;margin:0 auto;}
    .dataBody p{margin:0 0 12px;color:#334155;line-height:1.45;}
    .actionRow{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;}
    .actionRow .btn{display:inline-flex;align-items:center;gap:8px;text-decoration:none;}

    /* ------- Favorites / Trips additions ------- */
    .tripBar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0 14px}
    .tripPill{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px;font-weight:600;cursor:pointer}
    .tripPill.active{background:#eef2ff;border-color:#c7d2fe}
    .tripControls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
    .notesBox{width:100%;border:1px solid var(--ring);border-radius:10px;padding:8px;margin-top:8px;min-height:64px;resize:vertical}
    .miniRow{display:flex;gap:10px;align-items:center;justify-content:flex-start;margin:8px 0}
    .muted{color:#6b7280;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div> GALLIVANT</div>
      <div class="top"><input id="cityInput" class="search" placeholder="CITY" aria-label="City" /></div>
      <nav class="links">
        <a class="pill" href="#" id="myPlacesLink">MY PLACES</a>
        <a class="pill" href="#">NEW SITE SUBMISSION</a>
        <a class="pill" href="#">CONNECT</a>
      </nav>
    </header>

    <div class="tabs" role="tablist" aria-label="Content tabs">
      <button class="tab active" data-tab="all" role="tab" aria-selected="true">ALL</button>
      <button class="tab" data-tab="site" role="tab">SITES</button>
      <button class="tab" data-tab="tour" role="tab">TOURS</button>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <button class="view-map" id="viewMap"><span class="icon">üåê</span><strong>View in map</strong></button>

        <div class="panel filters" id="filtersPanelMain">
          <div class="group">
            <h3>Site Type</h3>
            <div id="siteTypeFiltersMain"></div>
          </div>
          <div class="group">
            <h3>Time Period</h3>
            <div id="periodFiltersMain"></div>
          </div>
          <details class="group" open>
            <summary>More Filters</summary>
            <div style="margin-top:8px" id="moreFiltersMain"></div>
          </details>
          <!-- ADDED: Dynamic filters container (keeps original intact) -->
          <div class="group" id="dynamicFiltersMain"></div>
        </div>
      </aside>

      <main>
        <section id="cards" class="grid" aria-live="polite"></section>
      </main>
    </div>
  </div>

  <!-- Map -->
  <section id="mapPanel" aria-hidden="true" role="dialog" aria-label="Map view of sites + tours">
    <div class="overlayHeader">
      <strong>GALLIVANT Map</strong>
      <div>
        <button id="mapShowAll" class="btn" title="Ignore filters temporarily">Show all</button>
        <button id="closeMap" class="btn">Back to list</button>
      </div>
    </div>

    <div class="mapLayout">
      <!-- Same filters in map -->
      <aside class="mapSidebar">
        <div class="panel filters" id="filtersPanelMap">
          <div class="group">
            <h3>Site Type</h3>
            <div id="siteTypeFiltersMap"></div>
          </div>
          <div class="group">
            <h3>Time Period</h3>
            <div id="periodFiltersMap"></div>
          </div>
          <details class="group" open>
            <summary>More Filters</summary>
            <div style="margin-top:8px" id="moreFiltersMap"></div>
          </details>
          <!-- ADDED: Dynamic filters container (map-side) -->
          <div class="group" id="dynamicFiltersMap"></div>
        </div>
      </aside>

      <div class="mapCanvas">
        <div id="map"></div>
        <div class="legend" id="mapLegend"></div>
      </div>
    </div>
  </section>

  <!-- My Places -->
  <section id="favoritesPanel" aria-hidden="true" role="dialog" aria-label="My Places">
    <div class="overlayHeader">
      <strong>My Places</strong>
      <div>
        <button id="clearFavorites" class="btn">Clear all</button>
        <button id="closeFavorites" class="btn">Back to list</button>
      </div>
    </div>
    <div style="padding:16px">
      <!-- ADDED: Trips + itinerary controls -->
      <div class="tripControls">
        <input id="newTripName" type="text" placeholder="New trip name (e.g., Chicago)" />
        <button id="addTripBtn" class="btn">Add Trip</button>
        <button id="renameTripBtn" class="btn">Rename</button>
        <button id="deleteTripBtn" class="btn">Delete Trip</button>
        <label class="field"><input type="checkbox" id="viewTripOnMap"> <span>View in Map</span></label>
        <button id="generateItineraryBtn" class="btn" title="Order by proximity">Generate Itinerary</button>
      </div>
      <div class="tripBar" id="tripBar"></div>
      <p class="muted">Tip: Save places with the heart. Assign them to a trip, add notes, and generate an order.</p>
      <section id="favoritesGrid" class="grid"></section>
    </div>
  </section>

  <!-- Our Data (kept from previous additions) -->
  <section id="ourDataPanel" aria-hidden="true" role="dialog" aria-label="About our data">
    <div class="overlayHeader">
      <strong>Our Data</strong>
      <div>
        <button id="closeOurData" class="btn">Back to list</button>
      </div>
    </div>
    <div class="dataBody">
      <p><strong>Traipse is a community resource.</strong> We rely on contributors and visitors to help keep details current‚Äîthings like hours, prices, accessibility, and transit info can change. If you spot anything that looks off, please let us know so we can keep the map accurate for everyone.</p>
      <div class="actionRow">
        <a id="suggestEditBtn" class="btn" href="#" title="Suggest an edit">‚úèÔ∏è <span>Suggest an Edit</span></a>
        <a id="newSiteBtn" class="btn" href="#" title="Submit a new site">‚ûï <span>New Site Submission</span></a>
      </div>
    </div>
  </section>

  <!-- Card template -->
  <template id="cardTemplate">
    <article class="card">
      <span class="badge"></span>
      <button class="fav" title="Save to My Places" aria-label="Save"><svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.65-7 10-7 10z"/></svg></button>
      <img class="img" alt="" />
      <div class="inner">
        <h3 class="title"></h3>
        <div class="meta"></div>
        <div class="chipbar"></div>
        <details class="more">
          <summary><span>More Info</span></summary>
          <div class="more-body">
            <div class="icons"></div>
            <p class="desc"></p>
            <!-- stats table injected here -->
            <!-- ADDED: notes area -->
            <textarea class="notesBox" placeholder="Notes for this place‚Ä¶ (saved to your device)"></textarea>
          </div>
        </details>
      </div>
    </article>
  </template>

  <script>
    /* ---------------- Label Maps ---------------- */
    const CATEGORY_LABELS = {
      generalhistory: 'General History', localhistory: 'Local History', indigenous: 'Indigenous History',
      militaryhistory: 'Military History', civilrights: 'Civil Rights', industrialhistory: 'Industrial History',
      architecturalhistory: 'Architectural History', artsandculture: 'Arts & Culture', religious: 'Religious',
      naturalhistory: 'Natural History', technologyandtransportation: 'Science & Technology', historichomes: 'Historic Homes',
      foodanddrink: 'Food & Drink', other: 'Other'
    };

    const PERIOD_LABELS = {
      prehistoric:'Prehistoric', colonial:'18th Century', eighteenthcentury:'18th Century', nineteenthcentury:'19th Century',
      twentiethcentury:'20th Century', industrialrevolution:'Industrial Era', modernhistory:'Modern History',
      indigenous:'Indigenous', other:'Other'
    };

    const SITETYPE_LABELS = {
      museums:'Museum', museum:'Museum', landmark:'Landmark', historichome:'Historical Home', historichomes:'Historical Home',
      archaeological:'Archaeological', archeological:'Archaeological', burial:'Burial', religious:'Religious', political:'Political',
      industrial:'Industrial', other:'Outdoor' // fallback
    };

    /* ---------------- Global State ---------------- */
    const state = {
      rawSites: [],
      rawTours: [],
      items: [],      // normalized items: sites + tours
      tab: 'all',
      favorites: new Set(JSON.parse(localStorage.getItem('traipse:favorites')||'[]')),
      city: '',
      geoloc: null,
      filters: { siteTypes:new Set(), periods:new Set(), tags:new Set() },
      // ADDED: dynamic filtering sets/fields
      df: {
        category:new Set(), duration:new Set(), cost:new Set(), estTime:new Set(),
        timeOfDay:new Set(), groupSize:new Set(), walkDistance:new Set(), reservation:Set.prototype // placeholder
      },
      // ADDED: trips
      trips: JSON.parse(localStorage.getItem('traipse:trips')||'{"Default":[],"current":"Default","notes":{}}')
    };
    if(!state.trips.current) state.trips.current = 'Default';

    // More Filters (existing) + kept
    const MORE_FILTERS = {
      spanishtranslations: 'Spanish translations',
      paymentmethod: 'Cash/Credit',
      luggagestorage: 'Luggage storage',
      hiddengem: 'Hidden gem',
      featured: 'Featured site',
      publicaccess: 'Public access',
      dogfriendly: 'Pet-friendly',
      family_friendly: 'Family-friendly',
      giftshop: 'Gift shop',
      foodbeverage: 'Food & beverage on-site',
      transit_accessible: 'Accessible by public transit',
      adaaccessibility: 'ADA accessibility'
    };

    /* ---------------- Helpers ---------------- */
    const resolveImage = (p)=>{
      if(!p) return '';
      if(/^https?:\/\//i.test(p)) return p;
      return p.startsWith('./') || p.startsWith('images/') ? p : `images/${p}`;
    };

    function haversine(a, b){
      const toRad = d => d*Math.PI/180;
      const R=6371; // km
      const dLat = toRad(b.lat-a.lat), dLng = toRad(b.lng-a.lng);
      const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));
    }
    const kmToMiles = km => km*0.621371;
    const formatMiles = m => !isFinite(m) ? '' : (m<0.2? `${(m*5280).toFixed(0)} ft away` : (m<10? `${m.toFixed(1)} mi away` : `${Math.round(m)} mi away`));

    // Determine if an item matches a "more filter" key
    function hasTag(it, key){
      const r = it.raw||{};
      switch(key){
        case 'paymentmethod': return (r.paymentmethod||'').toLowerCase()==='both';
        case 'hiddengem': return !!r.hiddenGem;
        case 'foodbeverage': return !!(r.diningonsite || r.diningonsite2);
        case 'transit_accessible': return (r.transit||'').toLowerCase()==='underhalfamilefromtransit';
        // direct boolean flags:
        case 'spanishtranslations': return !!r.spanishtranslations;
        case 'luggagestorage': return !!r.luggagestorage;
        case 'featured': return !!r.featured;
        case 'publicaccess': return !!r.publicaccess;
        case 'dogfriendly': return !!r.dogfriendly;
        case 'family_friendly': return !!r.family_friendly;
        case 'giftshop': return !!r.giftshop;
        case 'adaaccessibility': return !!r.adaaccessibility;
        default: return !!r[key];
      }
    }

    function scoreMatches(it){
      let score = 0;
      if(state.filters.siteTypes.size && state.filters.siteTypes.has(it.siteType)) score++;
      if(state.filters.periods.size){
        (it.periods||[]).forEach(p=>{ if(state.filters.periods.has(p)) score++; });
      }
      if(state.filters.tags.size){
        for(const key of state.filters.tags){ if(hasTag(it,key)) score++; }
      }
      // ADDED: dynamic filters scoring
      if(state.df.category.size){
        (it.categories||[]).forEach(c=>{ if(state.df.category.has(c)) score++; });
      }
      if(state.df.cost?.size){
        const c = (it.costText || it.raw?.Cost || '').toString();
        for(const v of state.df.cost){ if(c.toLowerCase().includes(v.toLowerCase())) { score++; break; } }
      }
      if(state.df.estTime?.size){
        const t = (it.durationText || it.raw?.estimatedtime || '').toString().toLowerCase();
        for(const v of state.df.estTime){ if(t.includes(v.toLowerCase())) { score++; break; } }
      }
      if(it.type==='Tour'){
        if(state.df.duration?.size){
          const d=(it.durationText||'').toLowerCase(); for(const v of state.df.duration){ if(d.includes(v.toLowerCase())){score++;break;} }
        }
        if(state.df.timeOfDay?.size){
          const tod=(it.raw?.time_of_day||'').toLowerCase(); for(const v of state.df.timeOfDay){ if(tod.includes(v.toLowerCase())){score++;break;} }
        }
        if(state.df.groupSize?.size){
          const gs=(it.raw?.group_type||it.raw?.group_size||'').toLowerCase(); for(const v of state.df.groupSize){ if(gs.includes(v.toLowerCase())){score++;break;} }
        }
        if(state.df.walkDistance?.size){
          const wd=(it.raw?.walking_distance||'').toLowerCase(); for(const v of state.df.walkDistance){ if(wd.includes(v.toLowerCase())){score++;break;} }
        }
        if(state.df.reservationRequired===true && it.raw?.reservation_required) score++;
        if(state.df.reservationRequired===false && it.raw?.reservation_required===false) score++;
      }
      return score;
    }

    function distanceFromUser(it){
      if(!state.geoloc) return Infinity;
      const pos = state.geoloc;
      let target = null;
      if(it.type==='Tour'){
        if(it.center){ target = it.center; }
      }else{
        const {lat,lng}=it.raw||{}; if(typeof lat==='number'&&typeof lng==='number'){ target={lat,lng}; }
      }
      if(!target) return Infinity;
      return kmToMiles(haversine({lat:pos.lat,lng:pos.lng}, target));
    }

    /* ---------------- Normalization ---------------- */
    function normalizeSite(raw){
      const periods = (raw.timeperiod||[]).map(p => PERIOD_LABELS[p]||p);
      const siteTypeSlug = (raw.sitetype||'').toLowerCase();
      const siteType = SITETYPE_LABELS[siteTypeSlug] || (raw.type==='outdoor' ? 'Outdoor' : (SITETYPE_LABELS.other));
      return {
        id: raw.id || (raw.name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-'),
        name: raw.name,
        type: 'Site',
        image: raw.image,
        website: raw.website && raw.website!=='notavailable' ? raw.website : '',
        categories: (raw.thematiccategory||[]).map(c => CATEGORY_LABELS[c]||c),
        siteType,
        periods,
        description: raw.description||'',
        costText: raw.dollaramount && !['0','$0','-'].includes(String(raw.dollaramount).trim()) ? String(raw.dollaramount) : (raw.cost==='free'?'Free': (raw.cost==='paid'?'Paid':'')),
        durationText: raw.estimatedtime || '',
        city: (raw.city||'').toLowerCase(),
        raw
      };
    }

    function normalizeTour(raw){
      let center=null;
      if(Array.isArray(raw.route) && raw.route.length){
        const lat = raw.route.reduce((a,b)=>a+b.lat,0)/raw.route.length;
        const lng = raw.route.reduce((a,b)=>a+b.lng,0)/raw.route.length;
        center = {lat,lng};
      }else if(Array.isArray(raw.sites) && raw.sites.length){
        center = {lat: raw.sites[0].lat, lng: raw.sites[0].lng};
      }

      return {
        id: raw.tour_id || (raw.tour_name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-'),
        name: raw.tour_name,
        type: 'Tour',
        image: raw.image,
        website: '',
        categories: [CATEGORY_LABELS[raw.thematiccategory]||raw.thematiccategory||'General'],
        siteType: 'Tour',
        periods: [],
        description: `${raw.duration||''} ‚Ä¢ ${raw.Cost||''}`.trim(),
        durationText: raw.duration || '',
        color: '#e11d48',
        center,
        raw
      };
    }

    /* ---------------- Filters UI (original) ---------------- */
    function addCheckbox(wrap, bucket, value, label){
      const id = `${bucket}-${value.replace(/[^a-z0-9]+/gi,'-')}-${wrap.id}`;
      const el = document.createElement('label');
      el.innerHTML = `<input type="checkbox" id="${id}"> <span>${label}</span>`;
      const input = el.querySelector('input');
      input.addEventListener('change', ()=>{
        const set = state.filters[bucket];
        if(input.checked) set.add(value); else set.delete(value);

        const source = wrap.id.endsWith('Map') ? 'map' : 'main';
        syncFilterUIs(source);
        render();
      });
      wrap.appendChild(el);
    }

    function buildFilters(target){
      const items = state.items;
      const siteTypes = Array.from(new Set(items.map(i=>i.siteType).filter(Boolean))).filter(t=>t!=='Tour').sort();
      const periodsSet = new Set();
      items.forEach(i=> (i.periods||[]).forEach(p=>periodsSet.add(p)));
      const periods = Array.from(periodsSet).sort();

      const siteWrap = document.getElementById(`siteTypeFilters${target}`);
      const perWrap  = document.getElementById(`periodFilters${target}`);
      const moreWrap = document.getElementById(`moreFilters${target}`);
      siteWrap.innerHTML = perWrap.innerHTML = moreWrap.innerHTML = '';

      siteTypes.forEach(label=>addCheckbox(siteWrap,'siteTypes',label,label));
      periods.forEach(p=>addCheckbox(perWrap,'periods',p,p));
      Object.entries(MORE_FILTERS).forEach(([k,v])=>addCheckbox(moreWrap,'tags',k,v));
    }

    function syncFilterUIs(source){
      const main = document.getElementById('filtersPanelMain');
      const mapP = document.getElementById('filtersPanelMap');

      const getCheckedWithLabels = (panel) => {
        const res = new Set();
        panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
          const label = cb.nextElementSibling?.textContent?.trim();
          if(cb.checked && label) res.add(label);
        });
        return res;
      };
      const setToByLabels = (panel, selected) => {
        panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
          const label = cb.nextElementSibling?.textContent?.trim();
          cb.checked = selected.has(label);
        });
      };

      if(source==='map'){
        setToByLabels(main, getCheckedWithLabels(mapP));
      }else{
        setToByLabels(mapP, getCheckedWithLabels(main));
      }
    }

    /* ---------------- ADDED: Dynamic Filters by Tab ---------------- */
    const DYN = {
      ALL: [
        {key:'category', type:'multiselect', label:'Category'},
        {key:'duration', type:'multiselect', label:'Duration'},
        {key:'cost', type:'multiselect', label:'Cost'},
        {key:'estTime', type:'multiselect', label:'Estimated Time'}
      ],
      SITES: [
        {key:'siteTypes', type:'existing', label:'Site Type'},
        {key:'periods', type:'existing', label:'Time Period'},
        {key:'category', type:'multiselect', label:'Category'},
        {key:'duration', type:'multiselect', label:'Duration'},
        {key:'cost', type:'multiselect', label:'Cost'},
        {key:'estTime', type:'multiselect', label:'Estimated Time'},
        // site flags map to MORE_FILTERS + hasTag
        {key:'dogfriendly', type:'flag', label:'Pet-friendly'},
        {key:'family_friendly', type:'flag', label:'Family-friendly'},
        {key:'giftshop', type:'flag', label:'Gift Shop'},
        {key:'foodbeverage', type:'flag', label:'Food and beverage on-site'},
        {key:'transit_accessible', type:'flag', label:'Accessible by public transit'},
        {key:'adaaccessibility', type:'flag', label:'ADA accessibility'},
        {key:'spanishtranslations', type:'flag', label:'Spanish translations'},
        {key:'paymentmethod', type:'choice', label:'Cash / Credit / Both', options:['Cash','Credit','Both']},
        {key:'luggagestorage', type:'flag', label:'Luggage Storage'},
        {key:'hiddengem', type:'flag', label:'Hidden Gem'},
        {key:'featured', type:'flag', label:'Featured Site'},
        {key:'publicaccess', type:'flag', label:'Public Access'}
      ],
      TOURS: [
        {key:'category', type:'multiselect', label:'Category'},
        {key:'cost', type:'multiselect', label:'Cost'},
        {key:'timeOfDay', type:'multiselect', label:'Time of Day'},
        {key:'duration', type:'multiselect', label:'Duration'},
        {key:'groupSize', type:'multiselect', label:'Group Size'},
        {key:'walkDistance', type:'multiselect', label:'Walking Distance'},
        {key:'reservationRequired', type:'toggle2', label:'Reservation Required in Advance'}
      ]
    };

    function collectOptionsFor(items){
      // build unique sets
      const categories = new Set();
      const durations = new Set();
      const costs = new Set();
      const times = new Set();
      const timeOfDay = new Set();
      const groupSize = new Set();
      const walkDistance = new Set();

      items.forEach(it=>{
        (it.categories||[]).forEach(c=>categories.add(c));
        const d = (it.durationText || it.raw?.duration || it.raw?.estimatedtime || '').trim();
        if(d) durations.add(d);
        const c = (it.costText || it.raw?.Cost || it.raw?.cost_range?.join(' - ') || '').trim();
        if(c) costs.add(c);
        const et = (it.raw?.estimatedtime || '').trim(); if(et) times.add(et);
        if(it.type==='Tour'){
          if(it.raw?.time_of_day) timeOfDay.add(it.raw.time_of_day);
          if(it.raw?.group_type || it.raw?.group_size) groupSize.add(it.raw.group_type || it.raw.group_size);
          if(it.raw?.walking_distance) walkDistance.add(it.raw.walking_distance);
        }
      });
      return {
        categories:[...categories].sort(),
        durations:[...durations].sort(),
        costs:[...costs].sort(),
        estTimes:[...times].sort(),
        timeOfDay:[...timeOfDay].sort(),
        groupSize:[...groupSize].sort(),
        walkDistance:[...walkDistance].sort()
      };
    }

    function buildDynamicFilters(target, tab){
      const host = document.getElementById(`dynamicFilters${target}`);
      if(!host) return;
      host.innerHTML = ''; // only clearing our dynamic container
      const items =
        tab==='site' ? state.items.filter(i=>i.type==='Site') :
        tab==='tour' ? state.items.filter(i=>i.type==='Tour') :
        state.items;
      const opts = collectOptionsFor(items);

      const spec = tab==='site' ? DYN.SITES : (tab==='tour' ? DYN.TOURS : DYN.ALL);
      spec.forEach(entry=>{
        const wrap = document.createElement('div');
        wrap.className='group';
        if(entry.type==='existing'){
          // we already render these in your original blocks; add a small helper label
          wrap.innerHTML = `<div class="muted">${entry.label} (see above)</div>`;
        } else if(entry.type==='multiselect'){
          const list =
            entry.key==='category' ? opts.categories :
            entry.key==='duration' ? opts.durations :
            entry.key==='cost' ? opts.costs :
            entry.key==='estTime' ? opts.estTimes :
            entry.key==='timeOfDay' ? opts.timeOfDay :
            entry.key==='groupSize' ? opts.groupSize :
            entry.key==='walkDistance' ? opts.walkDistance : [];
          if(list.length){
            const idBase = `${entry.key}-${target}`;
            const html = [`<h3>${entry.label}</h3>`].concat(list.map((v,i)=>(
              `<label><input type="checkbox" data-dyn="${entry.key}" value="${v}"> <span>${v}</span></label>`
            ))).join('');
            wrap.innerHTML = html;
          }
        } else if(entry.type==='flag'){
          wrap.innerHTML = `<label><input type="checkbox" data-flag="${entry.key}"> <span>${entry.label}</span></label>`;
        } else if(entry.type==='choice'){
          wrap.innerHTML = `
            <h3>${entry.label}</h3>
            <div class="field">
              <select data-choice="${entry.key}">
                <option value="">Any</option>
                ${entry.options.map(o=>`<option>${o}</option>`).join('')}
              </select>
            </div>`;
        } else if(entry.type==='toggle2'){
          wrap.innerHTML = `
            <h3>${entry.label}</h3>
            <label class="field"><input type="radio" name="res-${target}" data-res="true"> <span>Required</span></label>
            <label class="field"><input type="radio" name="res-${target}" data-res="false"> <span>Not required</span></label>
            <label class="field"><input type="radio" name="res-${target}" data-res="any" checked> <span>Any</span></label>`;
        }
        host.appendChild(wrap);
      });

      // wire inputs
      host.querySelectorAll('[data-dyn]').forEach(cb=>{
        cb.addEventListener('change', e=>{
          const k = e.target.getAttribute('data-dyn');
          state.df[k] = state.df[k] || new Set();
          if(e.target.checked) state.df[k].add(e.target.value);
          else state.df[k].delete(e.target.value);
          render();
        });
      });
      host.querySelectorAll('[data-flag]').forEach(cb=>{
        cb.addEventListener('change', e=>{
          const key = e.target.getAttribute('data-flag');
          if(e.target.checked) state.filters.tags.add(key); else state.filters.tags.delete(key);
          render();
        });
      });
      host.querySelectorAll('[data-choice]').forEach(sel=>{
        sel.addEventListener('change', e=>{
          const key = e.target.getAttribute('data-choice');
          // normalize into filters.tags/paymentmethod OR df.cost sets
          if(key==='paymentmethod'){
            // emulate original switch via tags paymentmethod === both; here we store selection
            state.df.paymentmethod = e.target.value; // 'Cash' | 'Credit' | 'Both' | ''
          }
          render();
        });
      });
      host.querySelectorAll('input[type=radio][data-res]').forEach(r=>{
        r.addEventListener('change', e=>{
          const v = e.target.getAttribute('data-res');
          state.df.reservationRequired = (v==='any') ? undefined : (v==='true');
          render();
        });
      });
    }

    /* ---------------- Chips / Cards ---------------- */
    function filterChips(it){
      const chips=[];
      if(state.filters.siteTypes.size && state.filters.siteTypes.has(it.siteType)) chips.push(it.siteType);
      if(state.filters.periods.size){ (it.periods||[]).forEach(p=>{ if(state.filters.periods.has(p)) chips.push(p); }); }
      if(state.filters.tags.size){
        Object.entries(MORE_FILTERS).forEach(([k,label])=>{
          if(state.filters.tags.has(k) && hasTag(it,k)) chips.push(label);
        });
      }
      if(state.df.category?.size){
        (it.categories||[]).forEach(c=>{ if(state.df.category.has(c)) chips.push(c); });
      }
      if(state.df.cost?.size){ chips.push('Cost filter'); }
      if(state.df.estTime?.size){ chips.push('Est. Time'); }
      if(state.df.duration?.size){ chips.push('Duration'); }
      if(state.df.timeOfDay?.size){ chips.push('Time of Day'); }
      if(state.df.groupSize?.size){ chips.push('Group size'); }
      if(state.df.walkDistance?.size){ chips.push('Walking distance'); }
      if(typeof state.df.reservationRequired==='boolean'){ chips.push(state.df.reservationRequired?'Reservation req.':'No reservation'); }
      return chips;
    }

    // Build the Stats table HTML for an item (original kept)
    function buildStatsTableHTML(it){
      const r = it.raw||{};
      const yesNo = v => v===undefined || v===null ? '‚Äî' : (v ? 'Yes' : 'No');

      const foodOnsite = !!(r.diningonsite || r.diningonsite2);
      const transitOk = (r.transit||'').toLowerCase()==='underhalfamilefromtransit';
      const payMethod = (r.paymentmethod||'').toLowerCase()==='both' ? 'Cash & credit' :
                        (r.paymentmethod||'') ? String(r.paymentmethod) : '‚Äî';

      const rowsSite = [
        ['Hours', r.hours||'‚Äî'],
        ['Cost', it.costText || '‚Äî'],
        ['Duration', it.durationText || '‚Äî'],
        ['Pet-friendly', yesNo(r.dogfriendly)],
        ['Family-friendly', yesNo(r.family_friendly)],
        ['Gift shop', yesNo(r.giftshop)],
        ['Food & beverage on-site', yesNo(foodOnsite)],
        ['Accessible by public transit', yesNo(transitOk)],
        ['ADA accessibility', yesNo(r.adaaccessibility)],
        ['Luggage storage', yesNo(r.luggagestorage)],
        ['Spanish translations', yesNo(r.spanishtranslations)],
        ['Public access', yesNo(r.publicaccess)],
        ['Payment method', payMethod]
      ];

      const rowsTour = [
        ['Duration', it.durationText || '‚Äî'],
        ['# of sites', r.number_of_sites || '‚Äî'],
        ['Cost', r.Cost || r.cost_range?.join(' - ') || '‚Äî'],
        ['Reservation required', yesNo(r.reservation_required)],
        ['Seasonal', yesNo(r.seasonal)],
        ['Group type', r.group_type || '‚Äî']
      ];

      const rows = it.type==='Tour' ? rowsTour : rowsSite;
      const tr = rows.map(([k,v])=>`<tr><th>${k}</th><td>${v}</td></tr>`).join('');
      return `<table class="stats" aria-label="Details"><tbody>${tr}</tbody></table>`;
    }

    function cardHTML(it, score, distMiles, asPopup=false){
      const chips = filterChips(it);
      const chipHtml = chips.map(c=>`<span class="chip">${c}</span>`).join('');
      const metaBits=[]; if(it.categories?.length){ metaBits.push(it.categories.join(', ')); } if(it.periods?.length){ metaBits.push(it.periods[0]); }
      const distanceText = formatMiles(distMiles);
      if(distanceText) metaBits.push(distanceText);
      const img = resolveImage(it.image) || 'images/default.jpg';

      const links = [];
      if(it.website){ links.push(`<a href="${it.website}" target="_blank" rel="noopener">üåê <span>Website</span></a>`); }
      if(it.type==='Tour' && it.raw?.external_links){
        for(const [name,url] of Object.entries(it.raw.external_links)){ links.push(`<a href="${url}" target="_blank" rel="noopener">üîó <span>${name}</span></a>`); }
      }
      const openCard = `<a href="#card-${it.id}" onclick="document.getElementById('closeMap').click(); setTimeout(()=>{document.getElementById('card-${it.id}')?.scrollIntoView({behavior:'smooth',block:'start'});},150); return false;">Open card</a>`;

      const stats = buildStatsTableHTML(it);

      return `
        <article class="card ${asPopup?'popup-card':''}" id="card-${it.id}">
          <span class="badge">${it.type||'Site'}</span>
          <button class="fav${state.favorites.has(it.id)?' active':''}" aria-label="Save" data-id="${it.id}">
            <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.65-7 10-7 10z"/></svg>
          </button>
          <img class="img" src="${img}" alt="${it.name} image" onerror="this.src='images/default.jpg'"/>
          <div class="inner">
            <h3 class="title">${it.name}</h3>
            <div class="meta">${metaBits.join(' ‚Ä¢ ')}</div>
            <div class="chipbar">${chipHtml}</div>
            <details class="more">
              <summary><span>More Info</span></summary>
              <div class="more-body">
                <div class="icons">${[...links, openCard].join(' ')}</div>
                <p class="desc">${it.description||''}</p>
                ${stats}
                <textarea class="notesBox" data-notes-for="${it.id}" placeholder="Notes for this place‚Ä¶ (saved to your device)"></textarea>
              </div>
            </details>
          </div>
        </article>`;
    }

    function buildCardNode(it, score, distMiles){
      const tpl = document.getElementById('cardTemplate');
      const node = tpl.content.cloneNode(true);
      const root = node.querySelector('.card');
      root.id = 'card-'+it.id;

      node.querySelector('.badge').textContent = it.type || 'Site';

      const fav = node.querySelector('.fav');
      fav.dataset.id = it.id;
      if(state.favorites.has(it.id)) fav.classList.add('active');
      fav.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFavorite(it.id); });

      const img = node.querySelector('.img');
      const requested = resolveImage(it.image);
      img.src = requested || 'images/default.jpg';
      img.alt = `${it.name} image`;
      img.onerror = ()=>{ img.src = 'images/default.jpg'; };

      node.querySelector('.title').textContent = it.name;

      const metaBits = [];
      if(it.categories?.length){ metaBits.push(it.categories.join(', ')); }
      if(it.periods?.length){ metaBits.push(it.periods[0]); }
      const distanceText = formatMiles(distMiles);
      if(distanceText) metaBits.push(distanceText);
      node.querySelector('.meta').textContent = metaBits.join(' ‚Ä¢ ');

      const chipbar = node.querySelector('.chipbar');
      const chips = filterChips(it);
      chips.forEach(c=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=c; chipbar.appendChild(s); });

      const icons = node.querySelector('.icons');
      const links=[];
      if(it.website){ links.push(`<a href="${it.website}" target="_blank" rel="noopener">üåê <span>Website</span></a>`); }
      if(it.type==='Tour' && it.raw?.external_links){
        for(const [name,url] of Object.entries(it.raw.external_links)){ links.push(`<a href="${url}" target="_blank" rel="noopener">üîó <span>${name}</span></a>`); }
      }
      icons.innerHTML = links.join(' ');
      node.querySelector('.desc').textContent = it.description||'';

      // Inject stats table
      const moreBody = root.querySelector('.more-body');
      const statsDiv = document.createElement('div');
      statsDiv.innerHTML = buildStatsTableHTML(it);
      moreBody.appendChild(statsDiv.firstElementChild);

      // ADDED: notes persistence
      const notes = root.querySelector('.notesBox');
      notes.value = (state.trips.notes?.[it.id]) || localStorage.getItem(`traipse:notes:${it.id}`) || '';
      notes.addEventListener('input', ()=>{
        localStorage.setItem(`traipse:notes:${it.id}`, notes.value);
        state.trips.notes = state.trips.notes || {};
        state.trips.notes[it.id] = notes.value;
        persistTrips();
      });

      return node;
    }

    /* ---------------- Favorites + Trips ---------------- */
    function persistTrips(){
      localStorage.setItem('traipse:trips', JSON.stringify(state.trips));
    }

    function toggleFavorite(id){
      if(state.favorites.has(id)) state.favorites.delete(id); else state.favorites.add(id);
      localStorage.setItem('traipse:favorites', JSON.stringify(Array.from(state.favorites)));
      document.querySelectorAll(`.fav[data-id="${id}"]`).forEach(b=>b.classList.toggle('active', state.favorites.has(id)));
      if(favoritesOpen) renderFavorites();
    }

    function getCurrentTripList(){
      const name = state.trips.current || 'Default';
      state.trips[name] = state.trips[name] || [];
      return state.trips[name];
    }

    function addToTrip(id, tripName){
      state.trips[tripName] = state.trips[tripName] || [];
      if(!state.trips[tripName].includes(id)) state.trips[tripName].push(id);
      persistTrips();
    }

    function removeFromTrip(id, tripName){
      const arr = state.trips[tripName] || [];
      state.trips[tripName] = arr.filter(x=>x!==id);
      persistTrips();
    }

    function renderTripBar(){
      const bar = document.getElementById('tripBar');
      const names = Object.keys(state.trips).filter(k=>k!=='current' && k!=='notes');
      if(!names.includes('Default')) names.unshift('Default');
      bar.innerHTML = names.map(n=>`<button class="tripPill ${state.trips.current===n?'active':''}" data-trip="${n}">${n}</button>`).join('');
      bar.querySelectorAll('[data-trip]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          state.trips.current = btn.getAttribute('data-trip');
          persistTrips();
          renderFavorites();
          renderTripBar();
          if(document.getElementById('viewTripOnMap').checked) { openMapWithTrip(); }
        });
      });
    }

    function renderFavorites(){
      const host = document.getElementById('favoritesGrid');
      const currentTrip = getCurrentTripList();
      // Build list of cards from favorites, but show current trip first
      const favItems = state.items.filter(it=>state.favorites.has(it.id));
      const tripSet = new Set(currentTrip);
      const list = favItems
        .map(it => ({it,score:scoreMatches(it),dist:distanceFromUser(it)}))
        .sort((a,b)=> {
          const aIn = tripSet.has(a.it.id), bIn = tripSet.has(b.it.id);
          if(aIn!==bIn) return aIn ? -1 : 1;
          return a.dist-b.dist;
        });
      host.innerHTML='';
      if(!list.length){
        host.innerHTML='<p style="color:#6b7280">No saved places yet. Tap the heart on any card or map popup to save it here.</p>';
        return;
      }
      list.forEach(({it,score,dist})=>{
        const node = buildCardNode(it,score,dist);
        // mini trip row
        const more = node.querySelector('.more-body');
        const mini = document.createElement('div');
        mini.className='miniRow';
        const inTrip = tripSet.has(it.id);
        mini.innerHTML = `
          <button class="btn" data-trip-toggle="${it.id}">${inTrip?'Remove from':'Add to'} "${state.trips.current}"</button>
          <button class="btn" data-center-map="${it.id}">View in Map</button>
        `;
        more.appendChild(mini);
        host.appendChild(node);

        mini.querySelector(`[data-trip-toggle="${it.id}"]`).addEventListener('click',()=>{
          if(tripSet.has(it.id)){ removeFromTrip(it.id, state.trips.current); }
          else{ addToTrip(it.id, state.trips.current); }
          renderFavorites();
        });
        mini.querySelector(`[data-center-map="${it.id}"]`).addEventListener('click',()=>{
          ensureMap();
          document.getElementById('favoritesPanel').style.display='none';
          document.getElementById('mapPanel').style.display='block';
          mapOpen=true;
          centerMapOnItem(it.id);
        });
      });
    }

    function centerMapOnItem(id){
      const it = state.items.find(x=>x.id===id);
      if(!it || !map) return;
      let latlng=null;
      if(it.type==='Site' && typeof it.raw?.lat==='number') latlng=[it.raw.lat,it.raw.lng];
      else if(it.type==='Tour' && it.center) latlng=[it.center.lat,it.center.lng];
      if(latlng){ map.setView(latlng, 15); }
    }

    function openMapWithTrip(){
      ensureMap();
      document.getElementById('mapPanel').style.display='block';
      mapOpen=true;
      renderMapPoints();
    }

    let favoritesOpen=false;
    document.getElementById('myPlacesLink').addEventListener('click', (e)=>{ e.preventDefault(); favoritesOpen=true; renderTripBar(); renderFavorites(); document.getElementById('favoritesPanel').style.display='block'; });
    document.getElementById('closeFavorites').addEventListener('click', ()=>{ favoritesOpen=false; document.getElementById('favoritesPanel').style.display='none'; });
    document.getElementById('clearFavorites').addEventListener('click', ()=>{
      state.favorites.clear();
      localStorage.setItem('traipse:favorites','[]');
      renderFavorites();
      document.querySelectorAll('.fav').forEach(b=>b.classList.remove('active'));
    });

    // Trip control buttons
    document.getElementById('addTripBtn').addEventListener('click', ()=>{
      const name = (document.getElementById('newTripName').value||'').trim();
      if(!name) return;
      if(!state.trips[name]) state.trips[name]=[];
      state.trips.current=name; persistTrips(); renderTripBar(); renderFavorites();
    });
    document.getElementById('renameTripBtn').addEventListener('click', ()=>{
      const cur = state.trips.current;
      if(cur==='Default') return alert('Cannot rename Default trip.');
      const name = prompt('New trip name:', cur);
      if(!name || name===cur) return;
      state.trips[name]=state.trips[cur]; delete state.trips[cur];
      state.trips.current=name; persistTrips(); renderTripBar(); renderFavorites();
    });
    document.getElementById('deleteTripBtn').addEventListener('click', ()=>{
      const cur = state.trips.current;
      if(cur==='Default') return alert('Cannot delete Default trip.');
      if(confirm(`Delete trip "${cur}"?`)){
        delete state.trips[cur];
        state.trips.current='Default';
        persistTrips(); renderTripBar(); renderFavorites();
      }
    });
    document.getElementById('viewTripOnMap').addEventListener('change', (e)=>{
      if(e.target.checked) openMapWithTrip();
      else document.getElementById('mapPanel').style.display='none';
    });
    document.getElementById('generateItineraryBtn').addEventListener('click', ()=>{
      const trip = getCurrentTripList();
      if(!trip.length || !state.geoloc) { alert('Need at least one place and location to order by proximity.'); return; }
      // simple greedy nearest-neighbor from user position
      const start = {lat:state.geoloc.lat, lng:state.geoloc.lng};
      const remaining = trip.slice();
      const ordered = [];
      let cur = start;
      while(remaining.length){
        let bestIdx=0, bestDist=Infinity;
        remaining.forEach((id,i)=>{
          const it = state.items.find(x=>x.id===id);
          let p=null; if(it?.type==='Site' && it.raw?.lat) p={lat:it.raw.lat,lng:it.raw.lng};
          else if(it?.type==='Tour' && it.center) p=it.center;
          const d = p? haversine(cur,p):1e9;
          if(d<bestDist){ bestDist=d; bestIdx=i; }
        });
        ordered.push(remaining.splice(bestIdx,1)[0]);
        const oit = state.items.find(x=>x.id===ordered[ordered.length-1]);
        if(oit?.type==='Site' && oit.raw?.lat) cur={lat:oit.raw.lat,lng:oit.raw.lng};
        else if(oit?.type==='Tour' && oit.center) cur=oit.center;
      }
      state.trips[state.trips.current]=ordered; persistTrips(); renderFavorites();
      if(document.getElementById('viewTripOnMap').checked) openMapWithTrip();
      alert('Itinerary generated.');
    });

    /* ---------------- Main render ---------------- */
    function passesTab(it){
      if(state.tab==='site') return it.type==='Site';
      if(state.tab==='tour') return it.type==='Tour';
      return true;
    }

    function cityPass(it){
      if(!state.city) return true;
      const c = (it.city||'').toLowerCase();
      return c.includes(state.city);
    }

    function renderCards(){
      const host = document.getElementById('cards');
      const list = state.items.filter(passesTab).filter(cityPass).map(it=>({
        it,
        score: scoreMatches(it),
        dist: distanceFromUser(it)
      })).sort((a,b)=> b.score-a.score || a.dist-b.dist);

      host.innerHTML='';
      if(!list.length){ host.innerHTML='<p style="color:#6b7280;padding:8px">No results.</p>'; return; }
      list.forEach(({it,score,dist})=> host.appendChild(buildCardNode(it,score,dist)));
    }

    function render(){ renderCards(); if(mapOpen) renderMapPoints(); }

    // Tabs
    document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      state.tab = btn.dataset.tab;
      // rebuild dynamic filters for both panels
      buildDynamicFilters('Main', state.tab);
      buildDynamicFilters('Map', state.tab);
      render();
    }));

    // City input
    document.getElementById('cityInput').addEventListener('input', e=>{
      state.city = (e.target.value||'').trim().toLowerCase();
      render();
    });

    /* ---------------- Load data + filters ---------------- */
    async function loadData(){
      try{
        const [siteRes,tourRes] = await Promise.all([
          fetch('locations.json?v='+Date.now()),
          fetch('tours.json?v='+Date.now())
        ]);
        const sites = await siteRes.json();
        const tours = await tourRes.json();

        state.rawSites = Array.isArray(sites)?sites: (sites.locations||[]);
        state.rawTours = Array.isArray(tours)?tours: (tours.tours||[]);

        const siteItems = state.rawSites.map(normalizeSite);
        const tourItems = state.rawTours.map(normalizeTour);
        state.items = [...siteItems, ...tourItems];

        buildFilters('Main');
        buildFilters('Map');
        syncFilterUIs('main');

        // initial dynamic filters
        buildDynamicFilters('Main', state.tab);
        buildDynamicFilters('Map', state.tab);

        render();
        locateUser();
      }catch(e){
        document.getElementById('cards').innerHTML = '<p style="color:#6b7280">Failed to load data files.</p>';
        console.error(e);
      }
    }

    /* ---------------- Geolocation ---------------- */
    function locateUser(){
      if(!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        pos => { state.geoloc={lat:pos.coords.latitude, lng:pos.coords.longitude}; render(); },
        () => {}, { enableHighAccuracy:true, timeout:7000, maximumAge:120000 }
      );
    }

    /* ---------------- Map ---------------- */
    let mapOpen=false, map, siteLayer, tourLayer;

    // Original color dictionary kept (not removed)
    const TYPE_COLORS = {
      'Museum':'#2563eb','Landmark':'#f97316','Historical Home':'#059669','Archaeological':'#7c3aed',
      'Religious':'#dc2626','Industrial':'#6b7280','Outdoor':'#16a34a','Burial':'#9ca3af','Political':'#2563eb'
    };

    function ensureMap(){
      if(map) return;
      map = L.map('map',{scrollWheelZoom:true});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
      siteLayer = L.layerGroup().addTo(map);
      tourLayer = L.layerGroup().addTo(map);
      buildLegend();

      map.on('popupopen', (e)=>{
        const btn = e.popup?.getElement()?.querySelector('.fav[data-id]');
        if(btn){
          btn.addEventListener('click',(ev)=>{ ev.stopPropagation(); toggleFavorite(btn.getAttribute('data-id')); });
        }
      });
    }

    function buildLegend(){
      const legend = document.getElementById('mapLegend');
      legend.innerHTML = '<strong>Legend</strong>';
      // keep original legend rows
      Object.entries(TYPE_COLORS).forEach(([label,color])=>{
        const row = document.createElement('div');
        row.className='legend-row';
        row.innerHTML = `<span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.12)"></span> <span>${label}</span>`;
        legend.appendChild(row);
      });
      const row = document.createElement('div');
      row.className='legend-row';
      row.innerHTML = `<span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:#e11d48;opacity:.55;border:1px solid #e11d48;"></span> <span>Tour area (size = matches)</span>`;
      legend.appendChild(row);

      // ADDED: pictogram legend
      const sep = document.createElement('div');
      sep.className='legend-row';
      sep.innerHTML = '<span class="muted">‚Äî</span> <span>Pictogram markers</span>';
      legend.appendChild(sep);

      const pictoRows = [
        ['Archaeological','ü¶ñ'],
        ['Landmark','\u25B2'], // triangle as monument silhouette
        ['Historical Home','üè†'],
        ['Museum','üèõÔ∏è'],
        ['Religious','‚õ™'],
        ['Outdoor','üå≤']
      ];
      pictoRows.forEach(([name,icon])=>{
        const r = document.createElement('div');
        r.className='legend-row';
        r.innerHTML = `<span style="display:inline-flex;width:18px;height:18px;align-items:center;justify-content:center;border:1px solid ${'#c7d2fe'};border-radius:6px;background:#eef2ff;font-size:12px">${icon}</span> <span>${name}</span>`;
        legend.appendChild(r);
      });
    }

    // Original icon function (kept)
    function siteIconFor(type){
      const color = TYPE_COLORS[type] || '#2563eb';
      return L.divIcon({
        className:'circle-icon',
        html:`<div style="width:18px;height:18px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.12)"></div>`,
        iconSize:[22,22], iconAnchor:[11,11]
      });
    }

    // ADDED: pictogram icon function (uses simple emoji/symbols to keep bundle minimal)
    function siteIconForPicto(type){
      const map = {
        'Archaeological':'ü¶ñ',
        'Landmark':'\u25B2', // monument-like
        'Historical Home':'üè†',
        'Museum':'üèõÔ∏è',
        'Religious':'‚õ™',
        'Outdoor':'üå≤',
        'Burial':'ü™¶',
        'Industrial':'üè≠',
        'Political':'üèõÔ∏è'
      };
      const glyph = map[type] || 'üìç';
      return L.divIcon({
        className:'picto-icon',
        html:`<div style="display:grid;place-items:center;width:22px;height:22px;border-radius:8px;background:#eef2ff;border:1px solid #c7d2fe;font-size:12px;line-height:1">${glyph}</div>`,
        iconSize:[22,22], iconAnchor:[11,11]
      });
    }

    // ADDED: switch to pictograms by default (without removing originals)
    let USE_PICTO_ICONS = true;

    function renderMapPoints(){
      if(!map) return;
      siteLayer.clearLayers();
      tourLayer.clearLayers();

      const sites = state.items.filter(it=>it.type==='Site' && passesTab(it)).filter(cityPass);
      const tours = state.items.filter(it=>it.type==='Tour' && passesTab(it));

      const bounds=[];

      // Sites: pictogram markers (fallback to colored circle if disabled)
      sites.forEach(it=>{
        const {lat,lng} = it.raw||{};
        if(typeof lat==='number' && typeof lng==='number'){
          const icon = USE_PICTO_ICONS ? siteIconForPicto(it.siteType) : siteIconFor(it.siteType);
          const m = L.marker([lat,lng],{icon}).addTo(siteLayer);
          const html = cardHTML(it, scoreMatches(it), distanceFromUser(it), true);
          m.bindPopup(html);
          bounds.push([lat,lng]);
        }
      });

      // Tours: soft red halos ONLY; size scales with match score; clickable to show card
      tours.forEach(it=>{
        if(it.center){
          const s = scoreMatches(it);
          const radius = 250 + 200 * s; // meters
          const circle = L.circle(it.center, {
            color:'#e11d48',
            fillColor:'#e11d48',
            fillOpacity:0.45,
            weight:1,
            radius
          }).addTo(tourLayer);
          const html = cardHTML(it, s, distanceFromUser(it), true);
          circle.bindPopup(html);
          bounds.push([it.center.lat, it.center.lng]);
        }
      });

      // if "View in Map" for trip is enabled, subtly emphasize those markers
      const viewTrip = document.getElementById('viewTripOnMap')?.checked;
      if(viewTrip){
        const set = new Set(getCurrentTripList());
        siteLayer.eachLayer(layer=>{
          const id = layer?._popup?.getContent()?.match(/id="card-([^"]+)"/)?.[1];
          if(id && set.has(id)){
            const el = layer.getElement();
            if(el) el.style.boxShadow = '0 0 0 3px rgba(37,99,235,.35)';
          }
        });
      }

      if(bounds.length){ map.fitBounds(bounds,{padding:[30,30]}); }
      else{ map.setView([39.7392,-104.9903], 11); }

      setTimeout(()=>map.invalidateSize(), 60);
    }

    document.getElementById('viewMap').addEventListener('click', ()=>{
      ensureMap();
      document.getElementById('mapPanel').style.display='block';
      mapOpen=true;
      syncFilterUIs('main');  // mirror current main filters into map panel on open
      renderMapPoints();
    });
    document.getElementById('closeMap').addEventListener('click', ()=>{
      document.getElementById('mapPanel').style.display='none';
      mapOpen=false;
    });
    document.getElementById('mapShowAll').addEventListener('click', ()=>{
      if(!map) return;
      const backup = {
        siteTypes:new Set(state.filters.siteTypes),
        periods:new Set(state.filters.periods),
        tags:new Set(state.filters.tags)
      };
      state.filters.siteTypes.clear(); state.filters.periods.clear(); state.filters.tags.clear();
      state.df = {category:new Set(), duration:new Set(), cost:new Set(), estTime:new Set()};
      syncFilterUIs('main'); renderMapPoints();
      state.filters.siteTypes=backup.siteTypes; state.filters.periods=backup.periods; state.filters.tags=backup.tags;
      syncFilterUIs('main');
    });

    /* ---------------- Init ---------------- */
    document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      state.tab = btn.dataset.tab;
      buildDynamicFilters('Main', state.tab);
      buildDynamicFilters('Map', state.tab);
      render();
    }));

    document.getElementById('cityInput').addEventListener('input', e=>{
      state.city = (e.target.value||'').trim().toLowerCase();
      render();
    });

    loadData();

    /* ---------- OUR DATA PANEL: rename nav link, wire up overlay (from earlier) ---------- */
    (function(){
      const navPills = document.querySelectorAll('nav.links .pill');
      if(navPills && navPills[1]){
        const ourDataLink = navPills[1];
        ourDataLink.textContent = 'OUR DATA';
        ourDataLink.id = 'ourDataLink';
        ourDataLink.setAttribute('aria-haspopup', 'dialog');
        ourDataLink.addEventListener('click', (e)=>{
          e.preventDefault();
          const panel = document.getElementById('ourDataPanel');
          if(panel){ panel.style.display = 'block'; panel.setAttribute('aria-hidden','false'); }
        });
      }

      const closeOurData = document.getElementById('closeOurData');
      if(closeOurData){
        closeOurData.addEventListener('click', ()=>{
          const panel = document.getElementById('ourDataPanel');
          if(panel){ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); }
        });
      }

      const suggestEditBtn = document.getElementById('suggestEditBtn');
      if(suggestEditBtn){
        suggestEditBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          alert('Suggest an Edit: wire this up to your form or route.');
        });
      }

      const newSiteBtn = document.getElementById('newSiteBtn');
      if(newSiteBtn){
        newSiteBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          alert('New Site Submission: wire this up to your form or route.');
        });
      }
    })();
  </script>
</body>
</html>
