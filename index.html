<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Traipse ‚Äî Sites + Tours (ranked filters, 3-col, tour halos)</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fa; --panel:#ffffff; --ink:#0f172a; --muted:#6b7280; --ring:#d1d5db; --brand:#00cfd4; --accent:#12a4ff;
      --radius:18px; --shadow:0 2px 12px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit}
    .wrap{max-width:1220px;margin:0 auto;padding:18px}

    /* Header */
    header{display:grid;grid-template-columns:auto 1fr auto;gap:18px;align-items:center;margin-bottom:8px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.05em}
    .logo{width:34px;height:34px;border-radius:12px;background:var(--brand);transform:rotate(18deg)}
    .top{display:flex;justify-content:center}
    .search{width:min(520px,100%);padding:10px 14px;border:1px solid var(--ring);border-radius:999px;background:#fff}
    .links{display:flex;gap:14px}
    .pill{border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;font-weight:600}

    /* Tabs */
    .tabs{display:flex;gap:26px;justify-content:center;margin:6px 0 12px}
    .tab{font-weight:800;letter-spacing:.08em;color:#111;opacity:.6;cursor:pointer;border:none;background:none;font-size:16px}
    .tab.active{opacity:1;text-decoration:underline;text-underline-offset:6px}

    /* Layout */
    .layout{display:grid;grid-template-columns:280px 1fr;gap:18px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}.sidebar{order:2}}

    /* Sidebar */
    .sidebar .panel{background:var(--panel);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .sidebar h3{margin:2px 0 10px;font-size:14px;text-transform:uppercase;letter-spacing:.1em}

    /* View in map ‚Äî white, card-like, aligned with filters */
    .view-map{
      display:flex;align-items:center;gap:12px;
      width:100%;padding:14px;background:#fff;border:1px solid var(--ring);
      border-radius:var(--radius);box-shadow:var(--shadow);color:inherit;font-weight:700;margin-bottom:14px
    }
    .view-map .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;background:#eaf5ff;color:#0b3a68;font-size:18px}

    .filters .group{margin-bottom:14px}
    .filters label{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:14px}
    .filters input[type="checkbox"]{width:16px;height:16px}
    details summary{cursor:pointer;color:#0b3a68;font-weight:700}

    /* Grid: 3 ‚Üí 2 ‚Üí 1 columns (wider cards) */
    .grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:18px;
    }
    @media (max-width:1000px){
      .grid{grid-template-columns:repeat(2, minmax(0,1fr))}
    }
    @media (max-width:640px){
      .grid{grid-template-columns:1fr}
    }

    /* Card */
    .card{position:relative;background:var(--panel);border:1px solid var(--ring);border-radius:20px;overflow:hidden;box-shadow:var(--shadow)}
    .badge{position:absolute;top:8px;left:8px;background:#111;color:#fff;font-size:10px;padding:3px 7px;border-radius:999px}
    .fav{position:absolute;top:8px;right:8px;width:30px;height:30px;border-radius:999px;display:grid;place-items:center;border:1px solid var(--ring);background:rgba(255,255,255,.9);cursor:pointer}
    .fav svg{width:16px;height:16px;fill:none;stroke:var(--accent);stroke-width:2}
    .fav.active svg{fill:var(--accent)}
    .img{width:100%;height:132px;object-fit:cover;border-bottom:1px solid var(--ring)}
    .inner{padding:10px 12px 12px}
    .title{font-size:18px;font-weight:800;margin:2px 0 4px}
    .meta{font-size:12px;color:#4b5563;margin-bottom:8px}
    .chipbar{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-flex;align-items:center;border:1px solid var(--ring);background:#f1f5f9;font-size:11px;border-radius:999px;padding:2px 6px}

    /* More Info */
    .more{margin-top:6px}
    .more summary{font-size:12px;color:#0b3a68;cursor:pointer;display:inline-flex;align-items:center;gap:6px;user-select:none}
    .more summary::marker{content:''}
    .more summary span{border-bottom:1px dotted #0b3a68}
    .more[open] summary span{border-bottom-style:solid}
    .more-body{margin-top:6px}
    .desc{font-size:13px;color:#334155;line-height:1.35;margin:0}
    .icons{display:flex;gap:10px;margin-top:6px;color:#607085}
    .icons a{display:inline-flex;align-items:center;gap:6px;text-decoration:none;font-size:12px}

    /* Overlays */
    #mapPanel,#favoritesPanel{position:fixed;inset:0;background:#fff;display:none;z-index:1000}
    .overlayHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--ring)}
    #map{height:calc(100vh - 56px);width:100%}
    .btn{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}

    /* Favorites (My Places) grid */
    #favoritesBody{padding:16px}
    #favoritesGrid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:18px}
    @media (max-width:1000px){#favoritesGrid{grid-template-columns:repeat(2, minmax(0,1fr))}}
    @media (max-width:640px){#favoritesGrid{grid-template-columns:1fr}}

    /* Map legend */
    .legend{position:absolute;bottom:16px;right:16px;background:#fff;border:1px solid var(--ring);border-radius:12px;box-shadow:var(--shadow);padding:8px 10px;font-size:12px}
    .legend-row{display:flex;align-items:center;gap:8px;margin:4px 0}

    /* Leaflet popup styled like card */
    .leaflet-popup-content { margin:0; }
    .leaflet-popup-content-wrapper { padding:0; border-radius:20px; overflow:hidden; border:1px solid var(--ring); box-shadow:var(--shadow); }
    .leaflet-popup-tip { display:none; }
    .leaflet-popup .fav { pointer-events:auto; }
    .popup-card .img{ height:132px; }
  </style>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div> TRAIPSE</div>
      <div class="top"><input id="cityInput" class="search" placeholder="CITY" aria-label="City" /></div>
      <nav class="links">
        <a class="pill" href="#" id="myPlacesLink">MY PLACES</a>
        <a class="pill" href="#">NEW SITE SUBMISSION</a>
        <a class="pill" href="#">CONNECT</a>
      </nav>
    </header>

    <div class="tabs" role="tablist" aria-label="Content tabs">
      <button class="tab active" data-tab="all" role="tab" aria-selected="true">ALL</button>
      <button class="tab" data-tab="site" role="tab">SITES</button>
      <button class="tab" data-tab="tour" role="tab">TOURS</button>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <button class="view-map" id="viewMap"><span class="icon">üåê</span><strong>View in map</strong></button>

        <div class="panel filters" id="filtersPanel">
          <div class="group">
            <h3>Site Type</h3>
            <div id="siteTypeFilters"></div>
          </div>
          <div class="group">
            <h3>Time Period</h3>
            <div id="periodFilters"></div>
          </div>
          <details class="group" open>
            <summary>More Filters</summary>
            <div style="margin-top:8px" id="moreFilters"></div>
          </details>
        </div>
      </aside>

      <main>
        <section id="cards" class="grid" aria-live="polite"></section>
      </main>
    </div>
  </div>

  <!-- Map overlay -->
  <section id="mapPanel" aria-hidden="true" role="dialog" aria-label="Map view of sites">
    <div class="overlayHeader">
      <strong>Traipse Map</strong>
      <div>
        <button id="mapShowAll" class="btn">Show all</button>
        <button id="closeMap" class="btn">Back to list</button>
      </div>
    </div>
    <div id="map"></div>
    <div class="legend" id="mapLegend" aria-hidden="true"></div>
  </section>

  <!-- Favorites overlay -->
  <section id="favoritesPanel" aria-hidden="true" role="dialog" aria-label="My Places">
    <div class="overlayHeader">
      <strong>My Places</strong>
      <div>
        <button id="clearFavorites" class="btn">Clear all</button>
        <button id="closeFavorites" class="btn">Back to list</button>
      </div>
    </div>
    <div id="favoritesBody">
      <section id="favoritesGrid"></section>
    </div>
  </section>

  <!-- Card template -->
  <template id="cardTemplate">
    <article class="card">
      <span class="badge"></span>
      <button class="fav" title="Save to My Places" aria-label="Save"><svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.65-7 10-7 10z"/></svg></button>
      <img class="img" alt="" />
      <div class="inner">
        <h3 class="title"></h3>
        <div class="meta"></div>
        <div class="chipbar"></div>
        <details class="more">
          <summary><span>More Info</span></summary>
          <div class="more-body">
            <div class="icons"></div>
            <p class="desc"></p>
          </div>
        </details>
      </div>
    </article>
  </template>

  <script>
    /* --------------------- Label maps --------------------- */
    const CATEGORY_LABELS = {
      generalhistory: 'General History', localhistory: 'Local History', indigenous: 'Indigenous History',
      militaryhistory: 'Military History', civilrights: 'Civil Rights', industrialhistory: 'Industrial History',
      architecturalhistory: 'Architectural History', artsandculture: 'Arts & Culture', religious: 'Religious',
      naturalhistory: 'Natural History', technologyandtransportation: 'Science & Technology', historichomes: 'Historic Homes',
      foodanddrink: 'Food & Drink', other: 'Other'
    };
    const PERIOD_LABELS = {
      prehistoric:'Prehistoric', colonial:'18th Century', eighteenthcentury:'18th Century', nineteenthcentury:'19th Century',
      twentiethcentury:'20th Century', industrialrevolution:'Industrial Era', modernhistory:'Modern History', indigenous:'Indigenous', other:'Other'
    };
    const SITETYPE_LABELS = {
      museums:'Museum', museum:'Museum', landmark:'Landmark', historichome:'Historical Home', historichomes:'Historical Home',
      archaeological:'Archaeological', archeological:'Archaeological', burial:'Burial', religious:'Religious', political:'Political',
      industrial:'Industrial', other:'Outdoor'
    };

    /* --------- Extra tag filters (predicates + labels) --------- */
    const TAG_FILTERS = {
      adaaccessibility:   { label:'ADA-Accessible',     predicate: it => it.kind==='site' && !!it.raw.adaaccessibility },
      dogfriendly:        { label:'Dog-Friendly',       predicate: it => it.kind==='site' && !!it.raw.dogfriendly },
      luggagestorage:     { label:'Luggage Storage',    predicate: it => it.kind==='site' && !!it.raw.luggagestorage },
      family_friendly:    { label:'Family-Friendly',    predicate: it => it.kind==='site' && !!it.raw.family_friendly },
      publicaccess:       { label:'Public Access',      predicate: it => it.kind==='site' && !!it.raw.publicaccess },
      spanishtranslations:{ label:'Spanish translations',predicate: it => it.kind==='site' && !!it.raw.spanishtranslations },
      payment_both:       { label:'Cash & Credit',      predicate: it => it.kind==='site' && String(it.raw.paymentmethod||'').toLowerCase()==='both' },
      featured:           { label:'Featured site',       predicate: it => it.kind==='site' && it.raw.featured===true },
      hiddengem:          { label:'Hidden gem',          predicate: it => it.kind==='site' && (it.raw.hiddengem===true || it.raw.featured===false) }
    };

    /* ------------------------ State ----------------------- */
    const state = {
      raw: { sites: [], tours: [] },
      items: [],
      tab: 'all',
      favorites: new Set(JSON.parse(localStorage.getItem('traipse:favorites')||'[]')),
      city: '',
      userLoc: null, // {lat,lng}
      filters: { siteTypes: new Set(), periods: new Set(), tags: new Set() }
    };

    /* -------------------- Normalizers --------------------- */
    function normalizeSite(raw){
      const periods = (raw.timeperiod||[]).map(p => PERIOD_LABELS[p]||p);
      const siteTypeSlug = (raw.sitetype||'').toLowerCase();
      const siteType = SITETYPE_LABELS[siteTypeSlug] || (raw.type==='outdoor' ? 'Outdoor' : (SITETYPE_LABELS.other));
      return {
        kind:'site',
        id: raw.id || (raw.name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-'),
        name: raw.name,
        type: 'Site',
        image: raw.image,
        website: raw.website && raw.website!=='notavailable' ? raw.website : '',
        categories: (raw.thematiccategory||[]).map(c => CATEGORY_LABELS[c]||c),
        siteType,
        periods,
        description: raw.description||'',
        costText: raw.dollaramount && !['0','$0','-'].includes(String(raw.dollaramount).trim()) ? String(raw.dollaramount) : (raw.cost==='free'?'Free': (raw.cost==='paid'?'Paid':'')),
        durationText: raw.estimatedtime || '',
        city: (raw.city||'').toLowerCase(),
        lat: typeof raw.lat==='number' ? raw.lat : undefined,
        lng: typeof raw.lng==='number' ? raw.lng : undefined,
        raw
      };
    }

    function firstLink(links){
      if(!links) return '';
      const keys = ['getyourguide','viator','airbnb','guruwalk','tripadvisor'];
      for(const k of keys){ if(links[k]) return links[k]; }
      const first = Object.values(links)[0];
      return typeof first === 'string' ? first : '';
    }

    function centroid(points){
      if(!points || !points.length) return null;
      let x=0,y=0; points.forEach(p=>{x+=p.lat; y+=p.lng;});
      return {lat:x/points.length, lng:y/points.length};
    }

    function normalizeTour(raw){
      const firstSite = Array.isArray(raw.sites) && raw.sites.length ? raw.sites[0] : null;
      const cat = CATEGORY_LABELS[(raw.thematiccategory||'').toLowerCase()] || 'Other';
      const center = centroid(raw.sites || raw.route) || (firstSite ? {lat:firstSite.lat,lng:firstSite.lng} : null);
      return {
        kind:'tour',
        id: raw.tour_id || (raw.tour_name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-'),
        name: raw.tour_name || 'Tour',
        type: 'Tour',
        image: raw.image,
        website: firstLink(raw.external_links),
        categories: [cat],
        siteType: 'Tour',
        periods: [],
        description: raw.duration ? `${raw.duration} ‚Ä¢ ${raw.number_of_sites||''} stops${raw.special_topic? ' ‚Ä¢ '+(raw.special_topic||[]).join(', '):''}` : (raw.description||''),
        costText: raw.Cost || (Array.isArray(raw.cost_range)? raw.cost_range.join(' / ') : ''),
        durationText: raw.duration || '',
        city: (firstSite?.city||'').toLowerCase(),
        lat: center?.lat, lng: center?.lng,
        route: Array.isArray(raw.route)? raw.route : [],
        sites: Array.isArray(raw.sites)? raw.sites : [],
        raw
      };
    }

    /* -------------------- Utilities ---------------------- */
    const resolveImage = (p)=>{
      if(!p) return '';
      if(/^https?:\/\//i.test(p)) return p;
      return p.startsWith('./') || p.startsWith('images/') ? p : `images/${p}`;
    };

    // Only show chips that match active filters
    function chipsFor(it){
      const chips=[];
      if(state.filters.siteTypes.size && state.filters.siteTypes.has(it.siteType)) chips.push(it.siteType);
      if(state.filters.periods.size){ (it.periods||[]).forEach(p=>{ if(state.filters.periods.has(p)) chips.push(p); }); }
      if(state.filters.tags.size){
        for(const key of state.filters.tags){
          const def = TAG_FILTERS[key];
          if(def && def.predicate(it)) chips.push(def.label);
        }
      }
      return chips;
    }

    function cardHTML(it, asPopup=false){
      const chips = chipsFor(it);
      const chipHtml = chips.length
        ? `<div class="chipbar">${chips.slice(0,5).map(c=>`<span class="chip">${c}</span>`).join('')}</div>`
        : '';
      const metaBits=[];
      if(it.categories?.length) metaBits.push(it.categories.join(', '));
      if(it.periods?.length) metaBits.push(it.periods[0]);
      if(typeof it.distanceMiles === 'number') metaBits.push(`${it.distanceMiles.toFixed(1)} mi away`);
      const img = resolveImage(it.image) || 'images/default.jpg';
      const website = it.website ? `<a href="${it.website}" target="_blank" rel="noopener">üåê <span>Website</span></a>` : '';

      const extraTour = it.type==='Tour'
        ? `<div class="icons" style="margin-top:6px">${website} ${it.sites?.length||it.route?.length? `<a href="#" data-zoom-tour="${it.id}">‚§¢ Zoom to tour</a>`:''}</div>`
        : `<div class="icons">${website}</div>`;

      return `
        <article class="card ${asPopup?'popup-card':''}" id="card-${it.id}">
          <span class="badge">${it.type||'Site'}</span>
          <button class="fav${state.favorites.has(it.id)?' active':''}" aria-label="Save" data-id="${it.id}">
            <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.65-7 10-7 10z"/></svg>
          </button>
          <img class="img" src="${img}" alt="${it.name} image" onerror="this.src='images/default.jpg'"/>
          <div class="inner">
            <h3 class="title">${it.name}</h3>
            <div class="meta">${metaBits.join(' ‚Ä¢ ')}</div>
            ${chipHtml}
            <details class="more">
              <summary><span>More Info</span></summary>
              <div class="more-body">
                ${extraTour}
                <p class="desc">${it.description||''}</p>
              </div>
            </details>
          </div>
        </article>`;
    }

    function addCheckbox(wrap, bucket, value, label){
      const id = `${bucket}-${value.replace(/[^a-z0-9]+/gi,'-')}`;
      const el = document.createElement('label');
      el.innerHTML = `<input type="checkbox" id="${id}"> <span>${label}</span>`;
      const input = el.querySelector('input');
      input.addEventListener('change', ()=>{
        const set = state.filters[bucket];
        if(input.checked) set.add(value); else set.delete(value);
        render();
      });
      wrap.appendChild(el);
    }

    // Non-binary filters: only tab & city gate; ranking handles the rest
    function passesFiltersBasic(item){
      if(state.tab==='site' && item.type!=='Site') return false;
      if(state.tab==='tour' && item.type!=='Tour') return false;
      if(state.city && item.city && !item.city.includes(state.city)) return false;
      return true;
    }

    function matchScore(item){
      let score = 0;
      if(state.filters.siteTypes.size && state.filters.siteTypes.has(item.siteType)) score++;
      if(state.filters.periods.size){
        (item.periods||[]).forEach(p=>{ if(state.filters.periods.has(p)) score++; });
      }
      if(state.filters.tags.size){
        for(const key of state.filters.tags){
          const def = TAG_FILTERS[key];
          if(def && def.predicate(item)) score++;
        }
      }
      return score;
    }

    function computeDistanceMiles(a,b){
      const R=3958.8, toRad=d=>d*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return R*2*Math.asin(Math.sqrt(s));
    }

    function enrichDistances(list){
      if(!state.userLoc) { list.forEach(it=>{ delete it.distanceMiles; }); return; }
      list.forEach(it=>{
        if(typeof it.lat==='number' && typeof it.lng==='number'){
          it.distanceMiles = computeDistanceMiles(state.userLoc, {lat:it.lat,lng:it.lng});
        }else{
          delete it.distanceMiles;
        }
      });
    }

    function sortItems(list){
      list.sort((a,b)=>{
        const sa = matchScore(a), sb = matchScore(b);
        if(sb!==sa) return sb-sa; // more matches first
        const da = (typeof a.distanceMiles === 'number') ? a.distanceMiles : Infinity;
        const db = (typeof b.distanceMiles === 'number') ? b.distanceMiles : Infinity;
        if(da!==db) return da-db; // nearer first
        return a.name.localeCompare(b.name);
      });
    }

    /* ------------------- Favorites ------------------- */
    function toggleFavorite(id){
      if(state.favorites.has(id)) state.favorites.delete(id); else state.favorites.add(id);
      localStorage.setItem('traipse:favorites', JSON.stringify(Array.from(state.favorites)));
      document.querySelectorAll(`.fav[data-id="${id}"]`).forEach(b=>b.classList.toggle('active', state.favorites.has(id)));
      if(favoritesOpen) renderFavorites();
    }

    function buildCardNode(it){
      const tpl = document.getElementById('cardTemplate');
      const node = tpl.content.cloneNode(true);
      const root = node.querySelector('.card');
      root.id = 'card-' + it.id;

      node.querySelector('.badge').textContent = it.type || 'Site';
      const fav = node.querySelector('.fav');
      fav.dataset.id = it.id;
      if(state.favorites.has(it.id)) fav.classList.add('active');
      fav.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFavorite(it.id); });

      const img = node.querySelector('.img');
      const requested = resolveImage(it.image);
      img.src = requested || 'images/default.jpg';
      img.alt = `${it.name} image`;
      img.onerror = ()=>{ img.src = 'images/default.jpg'; };

      node.querySelector('.title').textContent = it.name;

      const metaBits=[];
      if(it.categories?.length) metaBits.push(it.categories.join(', '));
      if(it.periods?.length) metaBits.push(it.periods[0]);
      if(typeof it.distanceMiles === 'number') metaBits.push(`${it.distanceMiles.toFixed(1)} mi away`);
      node.querySelector('.meta').textContent = metaBits.join(' ‚Ä¢ ');

      const chipbar = node.querySelector('.chipbar');
      const chips = chipsFor(it);
      if(chips.length){
        chipbar.style.display='flex';
        chips.slice(0,5).forEach(c=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=c; chipbar.appendChild(s); });
      }else{
        chipbar.style.display='none';
      }

      const icons = node.querySelector('.icons');
      const website = it.website ? `<a href="${it.website}" target="_blank" rel="noopener">üåê <span>Website</span></a>` : '';
      if(it.type==='Tour' && (it.sites?.length || it.route?.length)){
        const zoom = `<a href="#" data-zoom-tour="${it.id}">‚§¢ Zoom to tour</a>`;
        icons.innerHTML = `${website} ${zoom}`;
      }else{
        icons.innerHTML = website;
      }
      node.querySelector('.desc').textContent = it.description||'';

      return node;
    }

    function renderCards(list){
      const host = document.getElementById('cards');
      host.innerHTML = '';
      if(!list.length){ host.innerHTML = '<p style="color:#6b7280;padding:8px">No results match your filters.</p>'; return; }
      list.forEach(it => host.appendChild(buildCardNode(it)));

      // Wire up "Zoom to tour" links (cards)
      host.querySelectorAll('[data-zoom-tour]').forEach(a=>{
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          const id = a.getAttribute('data-zoom-tour');
          openMap(); // ensure map exists
          setTimeout(()=> zoomTourRoute(id), 50);
        });
      });
    }

    /* ------------------- Render cycle ------------------- */
    function render(){
      let list = state.items.filter(passesFiltersBasic);
      enrichDistances(list);
      sortItems(list);
      renderCards(list);
      if(mapOpen) renderMapPoints(list);
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      state.tab = btn.dataset.tab;
      render();
    }));

    // City filter
    document.getElementById('cityInput').addEventListener('input', e=>{ state.city = (e.target.value||'').trim().toLowerCase(); render(); });

    // My Places open/close/clear
    let favoritesOpen = false;
    document.getElementById('myPlacesLink').addEventListener('click', (e)=>{ e.preventDefault(); openFavorites(); });
    document.getElementById('closeFavorites').addEventListener('click', closeFavorites);
    document.getElementById('clearFavorites').addEventListener('click', ()=>{
      state.favorites.clear();
      localStorage.setItem('traipse:favorites', '[]');
      renderFavorites();
      document.querySelectorAll('.fav').forEach(b=>b.classList.remove('active'));
    });
    function openFavorites(){
      renderFavorites();
      document.getElementById('favoritesPanel').style.display='block';
      document.getElementById('favoritesPanel').setAttribute('aria-hidden','false');
      favoritesOpen = true;
    }
    function closeFavorites(){
      document.getElementById('favoritesPanel').style.display='none';
      document.getElementById('favoritesPanel').setAttribute('aria-hidden','true');
      favoritesOpen = false;
    }
    function renderFavorites(){
      const host = document.getElementById('favoritesGrid');
      const favItems = state.items.filter(it => state.favorites.has(it.id));
      host.innerHTML = '';
      if(!favItems.length){
        host.innerHTML = '<p style="color:#6b7280">No saved places yet. Tap the heart on any card or map popup to save it here.</p>';
        return;
      }
      enrichDistances(favItems);
      sortItems(favItems);
      favItems.forEach(it=> host.appendChild(buildCardNode(it)));

      // wire tour zooms inside favorites
      host.querySelectorAll('[data-zoom-tour]').forEach(a=>{
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          const id = a.getAttribute('data-zoom-tour');
          openMap(); setTimeout(()=> zoomTourRoute(id), 50);
        });
      });
    }

    /* ----------------- Filters init ----------------- */
    function initFilters(){
      initFilters = ()=>{}; // run once
      const siteTypes = Array.from(new Set(state.items.map(i=>i.siteType).concat(['Tour']))).sort();
      const siteWrap = document.getElementById('siteTypeFilters');
      siteTypes.forEach(label=>addCheckbox(siteWrap,'siteTypes',label,label));
      const periodSet = new Set(); state.items.forEach(i=>i.periods?.forEach(p=>periodSet.add(p)));
      const periodWrap = document.getElementById('periodFilters');
      Array.from(periodSet).sort().forEach(p=>addCheckbox(periodWrap,'periods',p,p));

      const moreWrap = document.getElementById('moreFilters');
      Object.entries(TAG_FILTERS).forEach(([k,def])=> addCheckbox(moreWrap,'tags',k,def.label));
    }

    /* ----------------- Data loading ---------------- */
    async function fetchJsonSafe(path, fallback = []) {
      try {
        const res = await fetch(path + '?v=' + Date.now());
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        return await res.json();
      } catch (e) {
        console.warn('Failed to fetch', path, e);
        return fallback;
      }
    }

    async function load(){
      const sitesRawJson = await fetchJsonSafe('locations.json', []);
      const toursRawJson = await fetchJsonSafe('tours.json', []);

      const sitesRaw = Array.isArray(sitesRawJson) ? sitesRawJson : (sitesRawJson.locations || []);
      const toursRaw = Array.isArray(toursRawJson) ? toursRawJson : (toursRawJson.tours || []);

      const sites = sitesRaw.map(normalizeSite);
      const tours = toursRaw.map(normalizeTour);

      state.raw = { sites: sitesRaw, tours: toursRaw };
      state.items = sites.concat(tours);

      if (!state.items.length) {
        document.getElementById('cards').innerHTML =
          '<p style="color:#6b7280">No data found. Ensure <code>locations.json</code> and/or <code>tours.json</code> are alongside <code>index.html</code>.</p>';
        return;
      }
      initFilters();
      requestUserLocation();
      render();
    }

    /* -------------- Geolocation (distance) --------------- */
    function requestUserLocation(){
      if(!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        pos => { state.userLoc = {lat:pos.coords.latitude, lng:pos.coords.longitude}; render(); },
        () => { /* silently ignore */ },
        { enableHighAccuracy:true, timeout:7000, maximumAge:300000 }
      );
    }

    /* -------------------- Map logic ---------------------- */
    let mapOpen = false;
    let map, markerLayer, polyLayer;

    // All tours = same red
    const TOUR_COLOR = '#dc2626';

    const TYPE_COLORS = {
      'Museum':'#2563eb','Landmark':'#f97316','Historical Home':'#059669','Archaeological':'#7c3aed',
      'Religious':'#dc2626','Industrial':'#6b7280','Outdoor':'#16a34a','Burial':'#9ca3af','Political':'#2563eb',
      'Tour': TOUR_COLOR
    };

    function ensureMap(){
      if(map) return;
      map = L.map('map',{scrollWheelZoom:true});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'&copy; OpenStreetMap contributors'
      }).addTo(map);
      markerLayer = L.layerGroup().addTo(map);
      polyLayer = L.layerGroup().addTo(map); // used for halos
      buildLegend();

      map.on('popupopen', (e)=>{
        const root = e.popup?.getElement();
        if(!root) return;
        const favBtn = root.querySelector('.fav[data-id]');
        if(favBtn){
          favBtn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            toggleFavorite(favBtn.getAttribute('data-id'));
          });
        }
        const zoom = root.querySelector('[data-zoom-tour]');
        if(zoom){
          zoom.addEventListener('click', (ev)=>{
            ev.preventDefault();
            zoomTourRoute(zoom.getAttribute('data-zoom-tour'));
          });
        }
      });
    }

    function buildLegend(){
      const legend = document.getElementById('mapLegend');
      legend.innerHTML = '';
      Object.entries(TYPE_COLORS).forEach(([label,color])=>{
        const row = document.createElement('div');
        row.className='legend-row';
        row.innerHTML = `<span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.12)"></span> <span>${label}</span>`;
        legend.appendChild(row);
      });
      legend.setAttribute('aria-hidden','false');
    }

    function circleIcon(color){
      return L.divIcon({
        className:'circle-icon',
        html:`<div style="width:18px;height:18px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.12)"></div>`,
        iconSize:[22,22], iconAnchor:[11,11]
      });
    }

    // Render: Sites as colored circles; Tours as a single clickable halo (no individual points)
    function renderMapPoints(list){
      if(!map) return;
      markerLayer.clearLayers(); polyLayer.clearLayers();

      const bounds = [];

      list.forEach(it=>{
        if(it.type === 'Tour'){
          // Compute center from sites/route or use stored lat/lng
          const pts = Array.isArray(it.sites) && it.sites.length
            ? it.sites.filter(s=>typeof s.lat==='number' && typeof s.lng==='number').map(s=>({lat:s.lat,lng:s.lng}))
            : (Array.isArray(it.route) && it.route.length
                ? it.route.filter(p=>typeof p.lat==='number' && typeof p.lng==='number')
                : []
              );
          let center = null;
          if(pts.length) center = centroid(pts);
          else if(typeof it.lat==='number' && typeof it.lng==='number') center = {lat:it.lat,lng:it.lng};

          if(center){
            // Radius: slightly larger than max distance of any stop from center; min radius for visibility
            const rMiles = pts.length ? pts.reduce((mx,p)=>{
              const d = computeDistanceMiles(center, {lat:p.lat,lng:p.lng});
              return Math.max(mx, d);
            }, 0) : 0.1; // default 0.1 mi if no points
            const rMeters = Math.max(180, rMiles * 1609.34 * 1.0);

            // Clickable halo circle with slightly higher opacity
            const halo = L.circle([center.lat, center.lng], {
              radius: rMeters,
              color: TOUR_COLOR,
              weight: 1.25,
              fillColor: TOUR_COLOR,
              fillOpacity: 0.22,   // a bit more opaque for visibility
              opacity: 0.8
            }).addTo(polyLayer);

            // Bind tour card popup to the circle itself
            halo.bindPopup(cardHTML(it,true));
            bounds.push([center.lat, center.lng]);
          }
        }else{
          // Sites as simple colored dots
          if(typeof it.lat==='number' && typeof it.lng==='number'){
            const m = L.marker([it.lat,it.lng], {icon: circleIcon(TYPE_COLORS[it.siteType]||'#3b82f6')}).addTo(markerLayer);
            m.bindPopup(cardHTML(it,true));
            bounds.push([it.lat,it.lng]);
          }
        }
      });

      if(bounds.length){ map.fitBounds(bounds, {padding:[30,30]}); }
      else { map.setView([39.7392,-104.9903], 10); } // Denver-ish
      setTimeout(()=>map.invalidateSize(), 50);
    }

    function zoomTourRoute(tourId){
      const tour = state.items.find(i=>i.type==='Tour' && i.id===tourId);
      if(!tour) return;
      const pts = (tour.sites||[]).filter(s=>typeof s.lat==='number' && typeof s.lng==='number');
      const rt  = (tour.route||[]).filter(p=>typeof p.lat==='number' && typeof p.lng==='number');
      const latlngs = (pts.length ? pts : rt).map(s=>[s.lat,s.lng]);
      if(latlngs.length){
        map.fitBounds(latlngs, {padding:[40,40]});
      }else if(typeof tour.lat==='number' && typeof tour.lng==='number'){
        map.setView([tour.lat, tour.lng], 14);
      }
    }

    function openMap(){
      ensureMap();
      document.getElementById('mapPanel').style.display='block';
      document.getElementById('mapPanel').setAttribute('aria-hidden','false');
      mapOpen = true;
      renderMapPoints(state.items.filter(passesFiltersBasic));
    }
    document.getElementById('viewMap').addEventListener('click', openMap);
    document.getElementById('closeMap').addEventListener('click', ()=>{
      document.getElementById('mapPanel').style.display='none';
      document.getElementById('mapPanel').setAttribute('aria-hidden','true');
      mapOpen = false;
    });
    document.getElementById('mapShowAll').addEventListener('click', ()=>{
      if(!map) return;
      renderMapPoints(state.items);
    });

    /* --------------------- Boot --------------------- */
    load();
  </script>
</body>
</html>
