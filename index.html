<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GALLIVANT ‚Äî Sites & Tours</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#f7f8fa; --panel:#ffffff; --ink:#0f172a; --muted:#6b7280; --ring:#d1d5db;
      /* Cyan system (unify all blues) */
      --brand:#00cfd4; --accent:#00cfd4;
      --radius:18px; --shadow:0 2px 12px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit}
    .wrap{max-width:1220px;margin:0 auto;padding:18px}

    /* Header / Nav */
    header{display:grid;grid-template-columns:auto 1fr auto;gap:18px;align-items:center;margin-bottom:8px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.05em}
    .logo{width:34px;height:34px;border-radius:12px;background:var(--brand);transform:rotate(18deg)}
    .top{display:flex;justify-content:center}
    .search{width:min(520px,100%);padding:10px 14px;border:1px solid var(--ring);border-radius:999px;background:#fff}
    .links{display:flex;gap:14px}
    .pill{border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;font-weight:600}

    /* Tabs */
    .tabs{display:flex;gap:26px;justify-content:center;margin:6px 0 12px}
    .tab{font-weight:800;letter-spacing:.08em;color:#111;opacity:.6;cursor:pointer;border:none;background:none;font-size:16px}
    .tab.active{opacity:1;text-decoration:underline;text-underline-offset:6px}

    /* Layout */
    .layout{display:grid;grid-template-columns:300px 1fr;gap:18px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}.sidebar{order:2}}

    /* Sidebar + Filters */
    .sidebar .panel{background:var(--panel);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .sidebar h3{margin:2px 0 10px;font-size:14px;text-transform:uppercase;letter-spacing:.1em}
    .view-map{
      display:flex;align-items:center;gap:12px;width:100%;padding:14px;background:#fff;border:1px solid var(--ring);
      border-radius:var(--radius);box-shadow:var(--shadow);color:inherit;font-weight:700;margin-bottom:14px
    }
    .view-map .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;background:#eafffb;color:#0b3a68;font-size:18px}
    .filters .group{margin-bottom:14px}
    .filters label{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:14px}
    .filters input[type="checkbox"], .filters input[type="radio"]{width:16px;height:16px}
    details summary{cursor:pointer;color:#0b3a68;font-weight:700}

    /* Cards grid ‚Äî 3 columns (wider) */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}

    /* Card */
    .card{position:relative;background:var(--panel);border:1px solid var(--ring);border-radius:20px;overflow:hidden;box-shadow:var(--shadow)}
    .badge{position:absolute;top:8px;left:8px;background:#111;color:#fff;font-size:10px;padding:3px 7px;border-radius:999px}
    .fav{position:absolute;top:8px;right:8px;width:30px;height:30px;border-radius:999px;display:grid;place-items:center;border:1px solid var(--ring);background:rgba(255,255,255,.9);cursor:pointer}
    .fav svg{width:16px;height:16px;fill:none;stroke:var(--accent);stroke-width:2}
    .fav.active svg{fill:var(--accent)}
    .img{width:100%;height:148px;object-fit:cover;border-bottom:1px solid var(--ring)}
    .inner{padding:12px 14px 14px}
    .title{font-size:18px;font-weight:800;margin:2px 0 4px}
    .meta{font-size:12px;color:#4b5563;margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap}
    .chipbar{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-flex;align-items:center;border:1px solid var(--ring);background:#f1f5f9;font-size:11px;border-radius:999px;padding:2px 6px}

    /* More Info */
    .more{margin-top:6px}
    .more summary{font-size:12px;color:#0b3a68;cursor:pointer;display:inline-flex;align-items:center;gap:6px;user-select:none}
    .more summary::marker{content:''}
    .more summary span{border-bottom:1px dotted #0b3a68}
    .more[open] summary span{border-bottom-style:solid}
    .more-body{margin-top:6px}
    .desc{font-size:13px;color:#334155;line-height:1.35;margin:0}
    .icons{display:flex;gap:10px;margin-top:6px;color:#607085}
    .icons a{display:inline-flex;align-items:center;gap:6px;text-decoration:none;font-size:12px}

    /* Stats table */
    .stats{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;color:#334155}
    .stats th{font-weight:600;text-align:left;padding:6px 0;width:52%}
    .stats td{padding:6px 0}
    .stats tr+tr th, .stats tr+tr td{border-top:1px dashed #e5e7eb}

    /* Overlays */
    #mapPanel,#favoritesPanel{position:fixed;inset:0;background:#fff;display:none;z-index:1000}
    .overlayHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--ring)}
    .btn{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}

    /* Map overlay layout */
    .mapLayout{display:grid;grid-template-columns:320px 1fr;gap:16px;height:calc(100vh - 56px)}
    .mapSidebar{padding:14px;border-right:1px solid var(--ring);overflow:auto}
    .mapCanvas{position:relative}
    #map{position:absolute;inset:0}
    .legend{position:absolute;bottom:16px;right:16px;background:#fff;border:1px solid var(--ring);border-radius:12px;box-shadow:var(--shadow);padding:8px 10px;font-size:12px}
    .legend-row{display:flex;align-items:center;gap:8px;margin:4px 0}

    /* Leaflet popup like a card */
    .leaflet-popup-content { margin:0; }
    .leaflet-popup-content-wrapper { padding:0; border-radius:20px; overflow:hidden; border:1px solid var(--ring); box-shadow:var(--shadow); }
    .leaflet-popup-tip { display:none; }
    .leaflet-popup .fav { pointer-events:auto; }
    .popup-card .img{ height:148px; }

    /* Smaller top-right pills (kept) */
    .links .pill{ font-size:12px; padding:6px 10px; }

    /* Our Data panel */
    #ourDataPanel{position:fixed;inset:0;background:#fff;display:none;z-index:1000}
    .dataBody{padding:16px;max-width:900px;margin:0 auto;}
    .dataBody p{margin:0 0 12px;color:#334155;line-height:1.45;}
    .actionRow{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;}
    .actionRow .btn{display:inline-flex;align-items:center;gap:8px;text-decoration:none;}

    /* Trip features */
    .tripControls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
    .tripBar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0 14px}
    .tripPill{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px;font-weight:600;cursor:pointer}
    .tripPill.active{background:#e6fffd;border-color:#b6fff8}
    .notesBox{width:100%;border:1px solid var(--ring);border-radius:10px;padding:8px;margin-top:8px;min-height:64px;resize:vertical}
    .miniRow{display:flex;gap:10px;align-items:center;justify-content:flex-start;margin:8px 0}
    .muted{color:#6b7280;font-size:12px}
    .select{border:1px solid var(--ring);border-radius:10px;padding:6px 10px;background:#fff;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div> GALLIVANT</div>
      <div class="top"><input id="cityInput" class="search" placeholder="CITY" aria-label="City" /></div>
      <nav class="links">
        <a class="pill" href="#" id="myPlacesLink">MY PLACES</a>
        <a class="pill" href="#">NEW SITE SUBMISSION</a>
        <a class="pill" href="#">CONNECT</a>
      </nav>
    </header>

    <div class="tabs" role="tablist" aria-label="Content tabs">
      <button class="tab active" data-tab="all" role="tab" aria-selected="true">ALL</button>
      <button class="tab" data-tab="site" role="tab">SITES</button>
      <button class="tab" data-tab="tour" role="tab">TOURS</button>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <button class="view-map" id="viewMap"><span class="icon">üåê</span><strong>View in map</strong></button>

        <div class="panel filters" id="filtersPanelMain">
          <div class="group">
            <h3>Site Type</h3>
            <div id="siteTypeFiltersMain"></div>
          </div>
          <div class="group">
            <h3>Time Period</h3>
            <div id="periodFiltersMain"></div>
          </div>
          <details class="group" open>
            <summary>More Filters</summary>
            <div style="margin-top:8px" id="moreFiltersMain"></div>
          </details>
          <!-- ADDED: Dynamic (tab-aware) filters -->
          <div class="group" id="dynamicFiltersMain"></div>
        </div>
      </aside>

      <main>
        <section id="cards" class="grid" aria-live="polite"></section>
      </main>
    </div>
  </div>

  <!-- Map -->
  <section id="mapPanel" aria-hidden="true" role="dialog" aria-label="Map view of sites + tours">
    <div class="overlayHeader">
      <strong>GALLIVANT Map</strong>
      <div>
        <button id="mapShowAll" class="btn" title="Ignore filters temporarily">Show all</button>
        <button id="closeMap" class="btn">Back to list</button>
      </div>
    </div>

    <div class="mapLayout">
      <!-- Same filters in map -->
      <aside class="mapSidebar">
        <div class="panel filters" id="filtersPanelMap">
          <div class="group">
            <h3>Site Type</h3>
            <div id="siteTypeFiltersMap"></div>
          </div>
          <div class="group">
            <h3>Time Period</h3>
            <div id="periodFiltersMap"></div>
          </div>
          <details class="group" open>
            <summary>More Filters</summary>
            <div style="margin-top:8px" id="moreFiltersMap"></div>
          </details>
          <!-- ADDED: Dynamic (tab-aware) filters -->
          <div class="group" id="dynamicFiltersMap"></div>
        </div>
      </aside>

      <div class="mapCanvas">
        <div id="map"></div>
        <div class="legend" id="mapLegend"></div>
      </div>
    </div>
  </section>

  <!-- My Places -->
  <section id="favoritesPanel" aria-hidden="true" role="dialog" aria-label="My Places">
    <div class="overlayHeader">
      <strong>My Places</strong>
      <div>
        <button id="clearFavorites" class="btn">Clear all</button>
        <button id="closeFavorites" class="btn">Back to list</button>
      </div>
    </div>
    <div style="padding:16px">
      <div class="tripControls">
        <input id="newTripName" class="select" type="text" placeholder="New trip name (e.g., Chicago)" />
        <button id="addTripBtn" class="btn">Add Trip</button>
        <button id="renameTripBtn" class="btn">Rename</button>
        <button id="deleteTripBtn" class="btn">Delete Trip</button>
        <label style="display:inline-flex;align-items:center;gap:6px">
          <input type="checkbox" id="viewTripOnMap"> <span>View in Map</span>
        </label>
        <button id="generateItineraryBtn" class="btn" title="Order by proximity">Generate Itinerary</button>
      </div>
      <div class="tripBar" id="tripBar"></div>
      <p class="muted">Tip: Save places with the heart. Assign them to a trip, add notes, and generate an order.</p>
      <section id="favoritesGrid" class="grid"></section>
    </div>
  </section>

  <!-- Our Data -->
  <section id="ourDataPanel" aria-hidden="true" role="dialog" aria-label="About our data">
    <div class="overlayHeader">
      <strong>Our Data</strong>
      <div>
        <button id="closeOurData" class="btn">Back to list</button>
      </div>
    </div>
    <div class="dataBody">
      <p><strong>Traipse is a community resource.</strong> We rely on contributors and visitors to help keep details current‚Äîthings like hours, prices, accessibility, and transit info can change. If you spot anything that looks off, please let us know so we can keep the map accurate for everyone.</p>
      <div class="actionRow">
        <a id="suggestEditBtn" class="btn" href="#" title="Suggest an edit">‚úèÔ∏è <span>Suggest an Edit</span></a>
        <a id="newSiteBtn" class="btn" href="#" title="Submit a new site">‚ûï <span>New Site Submission</span></a>
      </div>
    </div>
  </section>

  <!-- Card template -->
  <template id="cardTemplate">
    <article class="card">
      <span class="badge"></span>
      <button class="fav" title="Save to My Places" aria-label="Save"><svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.65-7 10-7 10z"/></svg></button>
      <img class="img" alt="" />
      <div class="inner">
        <h3 class="title"></h3>
        <div class="meta"></div>
        <div class="chipbar"></div>
        <details class="more">
          <summary><span>More Info</span></summary>
          <div class="more-body">
            <div class="icons"></div>
            <p class="desc"></p>
            <!-- stats table injected here -->
            <!-- notes area (kept from prior) -->
            <textarea class="notesBox" placeholder="Notes for this place‚Ä¶ (saved to your device)"></textarea>
            <!-- ADDED: quick add-to-trip row -->
            <div class="miniRow">
              <select class="select addToTripSelect"></select>
              <button class="btn addToTripBtn">Add to Trip</button>
            </div>
          </div>
        </details>
      </div>
    </article>
  </template>

  <script>
    /* ---------------- Label Maps ---------------- */
    const CATEGORY_LABELS = {
      generalhistory: 'General History', localhistory: 'Local History', indigenous: 'Indigenous History',
      militaryhistory: 'Military History', civilrights: 'Civil Rights', industrialhistory: 'Industrial History',
      architecturalhistory: 'Architectural History', artsandculture: 'Arts & Culture', religious: 'Religious',
      naturalhistory: 'Natural History', technologyandtransportation: 'Science & Technology', historichomes: 'Historic Homes',
      foodanddrink: 'Food & Drink', other: 'Other'
    };

    const PERIOD_LABELS = {
      prehistoric:'Prehistoric', colonial:'18th Century', eighteenthcentury:'18th Century', nineteenthcentury:'19th Century',
      twentiethcentury:'20th Century', industrialrevolution:'Industrial Era', modernhistory:'Modern History',
      indigenous:'Indigenous', other:'Other'
    };

    const SITETYPE_LABELS = {
      museums:'Museum', museum:'Museum', landmark:'Landmark', historichome:'Historical Home', historichomes:'Historical Home',
      archaeological:'Archaeological', archeological:'Archaeological', burial:'Burial', religious:'Religious', political:'Political',
      industrial:'Industrial', other:'Outdoor' // fallback
    };

    /* ---------------- Global State ---------------- */
    const state = {
      rawSites: [],
      rawTours: [],
      items: [],      // normalized items: sites + tours
      tab: 'all',
      favorites: new Set(JSON.parse(localStorage.getItem('traipse:favorites')||'[]')),
      city: '',
      geoloc: null,
      filters: { siteTypes:new Set(), periods:new Set(), tags:new Set() }, // ORIGINAL filters preserved
      dynamic: { // NEW: single source of truth for tab-aware filters
        category:new Set(), duration:new Set(), cost:new Set(), estTime:new Set(),
        pet:false, fam:false, gift:false, food:false, transit:false, ada:false, span:false,
        payment:'', luggage:false, hidden:false, featured:false, public:false,
        timeOfDay:new Set(), groupSize:new Set(), walkDistance:new Set(), reservation:'any'
      },
      trips2: JSON.parse(localStorage.getItem('traipse:trips2')||'{"current":"Default","lists":{"Default":[]}}')
    };
    if(!state.trips2.current) state.trips2.current='Default';
    if(!state.trips2.lists) state.trips2.lists={"Default":[]};

    // More Filters (original set kept)
    const MORE_FILTERS = {
      spanishtranslations: 'Spanish translations',
      paymentmethod: 'Cash/Credit',
      luggagestorage: 'Luggage storage',
      hiddengem: 'Hidden gem',
      featured: 'Featured site',
      publicaccess: 'Public access',
      dogfriendly: 'Pet-friendly',
      family_friendly: 'Family-friendly',
      giftshop: 'Gift shop',
      foodbeverage: 'Food & beverage on-site',
      transit_accessible: 'Accessible by public transit',
      adaaccessibility: 'ADA accessibility'
    };

    /* ---------------- Helpers ---------------- */
    const resolveImage = (p)=>{
      if(!p) return '';
      if(/^https?:\/\//i.test(p)) return p;
      return p.startsWith('./') || p.startsWith('images/') ? p : `images/${p}`;
    };

    function haversine(a, b){
      const toRad = d => d*Math.PI/180;
      const R=6371; // km
      const dLat = toRad(b.lat-a.lat), dLng = toRad(b.lng-a.lng);
      const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));
    }
    const kmToMiles = km => km*0.621371;
    const formatMiles = m => !isFinite(m) ? '' : (m<0.2? `${(m*5280).toFixed(0)} ft away` : (m<10? `${m.toFixed(1)} mi away` : `${Math.round(m)} mi away`));

    /* ---------------- Normalization ---------------- */
    function normalizeSite(raw){
      const periods = (raw.timeperiod||[]).map(p => PERIOD_LABELS[p]||p);
      const siteTypeSlug = (raw.sitetype||'').toLowerCase();
      const siteType = SITETYPE_LABELS[siteTypeSlug] || (raw.type==='outdoor' ? 'Outdoor' : (SITETYPE_LABELS.other));
      return {
        id: raw.id || (raw.name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-'),
        name: raw.name,
        type: 'Site',
        image: raw.image,
        website: raw.website && raw.website!=='notavailable' ? raw.website : '',
        categories: (raw.thematiccategory||[]).map(c => CATEGORY_LABELS[c]||c),
        siteType,
        periods,
        description: raw.description||'',
        costText: raw.dollaramount && !['0','$0','-'].includes(String(raw.dollaramount).trim()) ? String(raw.dollaramount) : (raw.cost==='free'?'Free': (raw.cost==='paid'?'Paid':'')),
        durationText: raw.estimatedtime || '',
        city: (raw.city||'').toLowerCase(),
        raw
      };
    }

    function normalizeTour(raw){
      let center=null;
      if(Array.isArray(raw.route) && raw.route.length){
        const lat = raw.route.reduce((a,b)=>a+b.lat,0)/raw.route.length;
        const lng = raw.route.reduce((a,b)=>a+b.lng,0)/raw.route.length;
        center = {lat,lng};
      }else if(Array.isArray(raw.sites) && raw.sites.length){
        center = {lat: raw.sites[0].lat, lng: raw.sites[0].lng};
      }

      return {
        id: raw.tour_id || (raw.tour_name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-'),
        name: raw.tour_name,
        type: 'Tour',
        image: raw.image,
        website: '',
        categories: [CATEGORY_LABELS[raw.thematiccategory]||raw.thematiccategory||'General'],
        siteType: 'Tour',
        periods: [],
        description: `${raw.duration||''} ‚Ä¢ ${raw.Cost||''}`.trim(),
        durationText: raw.duration || '',
        color: '#e11d48',
        center,
        raw
      };
    }

    /* ---------------- ORIGINAL filters UI (kept as-is) ---------------- */
    function addCheckbox(wrap, bucket, value, label){
      const id = `${bucket}-${value.replace(/[^a-z0-9]+/gi,'-')}-${wrap.id}`;
      const el = document.createElement('label');
      el.innerHTML = `<input type="checkbox" id="${id}"> <span>${label}</span>`;
      const input = el.querySelector('input');
      input.addEventListener('change', ()=>{
        const set = state.filters[bucket];
        if(input.checked) set.add(value); else set.delete(value);

        const source = wrap.id.endsWith('Map') ? 'map' : 'main';
        syncFilterUIs(source);
        render();
      });
      wrap.appendChild(el);
    }

    function buildFilters(target){
      const items = state.items;
      const siteTypes = Array.from(new Set(items.map(i=>i.siteType).filter(Boolean))).filter(t=>t!=='Tour').sort();
      const periodsSet = new Set();
      items.forEach(i=> (i.periods||[]).forEach(p=>periodsSet.add(p)));
      const periods = Array.from(periodsSet).sort();

      const siteWrap = document.getElementById(`siteTypeFilters${target}`);
      const perWrap  = document.getElementById(`periodFilters${target}`);
      const moreWrap = document.getElementById(`moreFilters${target}`);
      siteWrap.innerHTML = perWrap.innerHTML = moreWrap.innerHTML = '';

      siteTypes.forEach(label=>addCheckbox(siteWrap,'siteTypes',label,label));
      periods.forEach(p=>addCheckbox(perWrap,'periods',p,p));
      Object.entries(MORE_FILTERS).forEach(([k,v])=>addCheckbox(moreWrap,'tags',k,v));
    }

    function syncFilterUIs(source){
      const main = document.getElementById('filtersPanelMain');
      const mapP = document.getElementById('filtersPanelMap');

      const getCheckedWithLabels = (panel) => {
        const res = new Set();
        panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
          const label = cb.nextElementSibling?.textContent?.trim();
          if(cb.checked && label) res.add(label);
        });
        return res;
      };
      const setToByLabels = (panel, selected) => {
        panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
          const label = cb.nextElementSibling?.textContent?.trim();
          cb.checked = selected.has(label);
        });
      };

      if(source==='map'){
        setToByLabels(main, getCheckedWithLabels(mapP));
      }else{
        setToByLabels(mapP, getCheckedWithLabels(main));
      }
    }

    /* ---------------- DYNAMIC FILTERS (NEW) ---------------- */
    const TYPE_FOR_TAB = {
      all: ['Category','Duration','Cost','Estimated Time'],
      site: ['Site Type','Time Period','Category','Duration','Cost','Estimated Time','Pet-friendly','Family-friendly','Gift Shop','Food and beverage on-site','Accessible by public transit','ADA accessibility','Spanish translations','Cash / Credit / Both','Luggage Storage','Hidden Gem','Featured Site','Public Access'],
      tour: ['Category','Cost','Time of Day','Duration','Group Size','Walking Distance','Reservation Required in Advance']
    };

    function collectFacetOptions(items){
      const set = {category:new Set(), duration:new Set(), cost:new Set(), estTime:new Set(),
                   timeOfDay:new Set(), groupSize:new Set(), walkDistance:new Set()};
      items.forEach(it=>{
        (it.categories||[]).forEach(c=>set.category.add(c));
        const dur = (it.durationText||it.raw?.duration||it.raw?.estimatedtime||'').trim(); if(dur) set.duration.add(dur);
        const cost = (it.costText||it.raw?.Cost||it.raw?.cost_range?.join(' - ')||'').trim(); if(cost) set.cost.add(cost);
        const est = (it.raw?.estimatedtime||'').trim(); if(est) set.estTime.add(est);
        if(it.type==='Tour'){
          if(it.raw?.time_of_day) set.timeOfDay.add(it.raw.time_of_day);
          if(it.raw?.group_type || it.raw?.group_size) set.groupSize.add(it.raw.group_type||it.raw.group_size);
          if(it.raw?.walking_distance) set.walkDistance.add(it.raw.walking_distance);
        }
      });
      const asArr = o => Array.from(o).sort();
      return {
        category: asArr(set.category),
        duration: asArr(set.duration),
        cost: asArr(set.cost),
        estTime: asArr(set.estTime),
        timeOfDay: asArr(set.timeOfDay),
        groupSize: asArr(set.groupSize),
        walkDistance: asArr(set.walkDistance)
      };
    }

    function renderDynamicFilters(target){
      const tab = state.tab;
      const host = document.getElementById(`dynamicFilters${target}`);
      if(!host) return;
      host.innerHTML = '';

      // Which items to sample options from
      const srcItems = tab==='site' ? state.items.filter(i=>i.type==='Site')
                     : tab==='tour' ? state.items.filter(i=>i.type==='Tour')
                     : state.items;
      const opts = collectFacetOptions(srcItems);

      function checkboxList(title, key, values){
        const wrap = document.createElement('div');
        wrap.className='group';
        wrap.innerHTML = `<h3>${title}</h3>` + values.map(v=>(
          `<label><input type="checkbox" data-dyn="${key}" value="${v}"> <span>${v}</span></label>`
        )).join('');
        host.appendChild(wrap);
      }
      function singleChoice(title, key, arr){
        const wrap = document.createElement('div');
        wrap.className='group';
        wrap.innerHTML = `<h3>${title}</h3><select data-choice="${key}" class="select">
          <option value="">Any</option>
          ${arr.map(v=>`<option value="${v}">${v}</option>`).join('')}
        </select>`;
        host.appendChild(wrap);
      }
      function bool(title, key){
        const wrap = document.createElement('div');
        wrap.className='group';
        wrap.innerHTML = `<label><input type="checkbox" data-flag="${key}"> <span>${title}</span></label>`;
        host.appendChild(wrap);
      }
      function radio3(title, key){
        const wrap = document.createElement('div');
        wrap.className='group';
        wrap.innerHTML = `<h3>${title}</h3>
          <label><input type="radio" name="${key}-${target}" data-res="${key}" value="any" checked> Any</label>
          <label><input type="radio" name="${key}-${target}" data-res="${key}" value="required"> Required</label>
          <label><input type="radio" name="${key}-${target}" data-res="${key}" value="not"> Not required</label>`;
        host.appendChild(wrap);
      }

      // Build per tab
      if(tab==='all'){
        if(opts.category.length) checkboxList('Category','category',opts.category);
        if(opts.duration.length) checkboxList('Duration','duration',opts.duration);
        if(opts.cost.length) checkboxList('Cost','cost',opts.cost);
        if(opts.estTime.length) checkboxList('Estimated Time','estTime',opts.estTime);
      }
      if(tab==='site'){
        // (Keep original groups visible above)
        if(opts.category.length) checkboxList('Category','category',opts.category);
        if(opts.duration.length) checkboxList('Duration','duration',opts.duration);
        if(opts.cost.length) checkboxList('Cost','cost',opts.cost);
        if(opts.estTime.length) checkboxList('Estimated Time','estTime',opts.estTime);

        bool('Pet-friendly','pet');
        bool('Family-friendly','fam');
        bool('Gift Shop','gift');
        bool('Food and beverage on-site','food');
        bool('Accessible by public transit','transit');
        bool('ADA accessibility','ada');
        bool('Spanish translations','span');
        singleChoice('Cash / Credit / Both','payment',['Cash','Credit','Both']);
        bool('Luggage Storage','luggage');
        bool('Hidden Gem','hidden');
        bool('Featured Site','featured');
        bool('Public Access','public');
      }
      if(tab==='tour'){
        if(opts.category.length) checkboxList('Category','category',opts.category);
        if(opts.cost.length) checkboxList('Cost','cost',opts.cost);
        if(opts.timeOfDay.length) checkboxList('Time of Day','timeOfDay',opts.timeOfDay);
        if(opts.duration.length) checkboxList('Duration','duration',opts.duration);
        if(opts.groupSize.length) checkboxList('Group Size','groupSize',opts.groupSize);
        if(opts.walkDistance.length) checkboxList('Walking Distance','walkDistance',opts.walkDistance);
        radio3('Reservation Required in Advance','reservation');
      }

      // Sync values from state.dynamic ‚Üí UI (so Map/Main mirror)
      // checkboxes
      host.querySelectorAll('[data-dyn]').forEach(cb=>{
        const k = cb.getAttribute('data-dyn');
        cb.checked = state.dynamic[k]?.has(cb.value) || false;
        cb.addEventListener('change', ()=>{
          if(!state.dynamic[k]) state.dynamic[k] = new Set();
          if(cb.checked) state.dynamic[k].add(cb.value); else state.dynamic[k].delete(cb.value);
          mirrorDynamic(target); render();
        });
      });
      // flags
      host.querySelectorAll('[data-flag]').forEach(cb=>{
        const k = cb.getAttribute('data-flag');
        cb.checked = !!state.dynamic[k];
        cb.addEventListener('change', ()=>{ state.dynamic[k]=cb.checked; mirrorDynamic(target); render(); });
      });
      // single choice
      host.querySelectorAll('[data-choice]').forEach(sel=>{
        const k = sel.getAttribute('data-choice');
        sel.value = (state.dynamic[k]||'');
        sel.addEventListener('change', ()=>{ state.dynamic[k]=sel.value; mirrorDynamic(target); render(); });
      });
      // reservation 3-way
      host.querySelectorAll('[data-res]').forEach(r=>{
        r.checked = (state.dynamic.reservation||'any')===r.value;
        r.addEventListener('change', ()=>{ if(r.checked){ state.dynamic.reservation=r.value; mirrorDynamic(target); render(); }});
      });
    }

    // Mirror dynamic UI between Main and Map
    function mirrorDynamic(sourceTarget){
      const other = sourceTarget==='Main' ? 'Map' : 'Main';
      renderDynamicFilters(other);
    }

    // Does item pass current tab's dynamic filters?
    function itemPassesDynamic(it){
      const dy = state.dynamic;
      const inSet = (set, value) => !set?.size || set.has(value);

      // Category
      if(dy.category?.size){
        const ok = (it.categories||[]).some(c=>dy.category.has(c));
        if(!ok) return false;
      }
      // Duration (match text includes)
      if(dy.duration?.size){
        const t = (it.durationText||it.raw?.duration||it.raw?.estimatedtime||'').toLowerCase();
        let ok=false; for(const v of dy.duration){ if(t.includes(String(v).toLowerCase())){ ok=true; break; } }
        if(!ok) return false;
      }
      // Cost
      if(dy.cost?.size){
        const c = (it.costText||it.raw?.Cost||it.raw?.cost_range?.join(' - ')||'').toLowerCase();
        let ok=false; for(const v of dy.cost){ if(c.includes(String(v).toLowerCase())){ ok=true; break; } }
        if(!ok) return false;
      }
      // Estimated Time
      if(dy.estTime?.size){
        const e = (it.raw?.estimatedtime||it.durationText||'').toLowerCase();
        let ok=false; for(const v of dy.estTime){ if(e.includes(String(v).toLowerCase())){ ok=true; break; } }
        if(!ok) return false;
      }

      if(it.type==='Site' && state.tab!=='tour'){
        // booleans
        const r=it.raw||{};
        if(dy.pet && !r.dogfriendly) return false;
        if(dy.fam && !r.family_friendly) return false;
        if(dy.gift && !r.giftshop) return false;
        if(dy.food && !(r.diningonsite || r.diningonsite2)) return false;
        if(dy.transit && (String(r.transit||'').toLowerCase()!=='underhalfamilefromtransit')) return false;
        if(dy.ada && !r.adaaccessibility) return false;
        if(dy.span && !r.spanishtranslations) return false;
        if(dy.luggage && !r.luggagestorage) return false;
        if(dy.hidden && !r.hiddenGem) return false;
        if(dy.featured && !r.featured) return false;
        if(dy.public && !r.publicaccess) return false;
        if(dy.payment){
          const pm = String(r.paymentmethod||'').toLowerCase();
          if(dy.payment==='Cash' && pm!=='cash') return false;
          if(dy.payment==='Credit' && pm!=='credit') return false;
          if(dy.payment==='Both' && pm!=='both') return false;
        }
      }

      if(it.type==='Tour' && state.tab!=='site'){
        const r=it.raw||{};
        // Time of Day
        if(dy.timeOfDay?.size){
          const val = String(r.time_of_day||'').toLowerCase();
          let ok=false; for(const v of dy.timeOfDay){ if(val.includes(String(v).toLowerCase())){ ok=true; break; } }
          if(!ok) return false;
        }
        // Group Size
        if(dy.groupSize?.size){
          const val = String(r.group_type||r.group_size||'').toLowerCase();
          let ok=false; for(const v of dy.groupSize){ if(val.includes(String(v).toLowerCase())){ ok=true; break; } }
          if(!ok) return false;
        }
        // Walking Distance
        if(dy.walkDistance?.size){
          const val = String(r.walking_distance||'').toLowerCase();
          let ok=false; for(const v of dy.walkDistance){ if(val.includes(String(v).toLowerCase())){ ok=true; break; } }
          if(!ok) return false;
        }
        // Reservation
        if(dy.reservation==='required' && !r.reservation_required) return false;
        if(dy.reservation==='not' && !!r.reservation_required) return false;
      }

      // Legacy checkboxes still apply for SITES tab (Site Type / Time Period / More Filters)
      if(state.tab==='site'){
        if(state.filters.siteTypes.size && !state.filters.siteTypes.has(it.siteType)) return false;
        if(state.filters.periods.size){
          const ok = (it.periods||[]).some(p=>state.filters.periods.has(p));
          if(!ok) return false;
        }
        if(state.filters.tags.size){
          let ok=true;
          for(const key of state.filters.tags){ if(!hasTag(it,key)){ ok=false; break; } }
          if(!ok) return false;
        }
      }
      return true;
    }

    /* ---------------- Score & Distance (original with cyan tweak) ---------------- */
    function hasTag(it, key){
      const r = it.raw||{};
      switch(key){
        case 'paymentmethod': return (r.paymentmethod||'').toLowerCase()==='both';
        case 'hiddengem': return !!r.hiddenGem;
        case 'foodbeverage': return !!(r.diningonsite || r.diningonsite2);
        case 'transit_accessible': return (r.transit||'').toLowerCase()==='underhalfamilefromtransit';
        case 'spanishtranslations': return !!r.spanishtranslations;
        case 'luggagestorage': return !!r.luggagestorage;
        case 'featured': return !!r.featured;
        case 'publicaccess': return !!r.publicaccess;
        case 'dogfriendly': return !!r.dogfriendly;
        case 'family_friendly': return !!r.family_friendly;
        case 'giftshop': return !!r.giftshop;
        case 'adaaccessibility': return !!r.adaaccessibility;
        default: return !!r[key];
      }
    }

    function scoreMatches(it){
      let score = 0;
      if(state.filters.siteTypes.size && state.filters.siteTypes.has(it.siteType)) score++;
      if(state.filters.periods.size){
        (it.periods||[]).forEach(p=>{ if(state.filters.periods.has(p)) score++; });
      }
      if(state.filters.tags.size){
        for(const key of state.filters.tags){ if(hasTag(it,key)) score++; }
      }
      // dynamic weights (light)
      if(itemPassesDynamic(it)) score++;
      return score;
    }

    function distanceFromUser(it){
      if(!state.geoloc) return Infinity;
      const pos = state.geoloc;
      let target = null;
      if(it.type==='Tour'){
        if(it.center){ target = it.center; }
      }else{
        const {lat,lng}=it.raw||{}; if(typeof lat==='number'&&typeof lng==='number'){ target={lat,lng}; }
      }
      if(!target) return Infinity;
      return kmToMiles(haversine({lat:pos.lat,lng:pos.lng}, target));
    }

    /* ---------------- Chips ---------------- */
    function filterChips(it){
      const chips=[];
      if(state.filters.siteTypes.size && state.filters.siteTypes.has(it.siteType)) chips.push(it.siteType);
      if(state.filters.periods.size){ (it.periods||[]).forEach(p=>{ if(state.filters.periods.has(p)) chips.push(p); }); }
      if(state.filters.tags.size){
        Object.entries(MORE_FILTERS).forEach(([k,label])=>{
          if(state.filters.tags.has(k) && hasTag(it,k)) chips.push(label);
        });
      }
      const dy=state.dynamic;
      if(dy.category?.size){ (it.categories||[]).forEach(c=>{ if(dy.category.has(c)) chips.push(c); }); }
      if(dy.reservation==='required' && it.type==='Tour') chips.push('Reservation req.');
      if(dy.payment) chips.push(`Pay: ${dy.payment}`);
      return chips;
    }

    /* ---------------- Stats (original) ---------------- */
    function buildStatsTableHTML(it){
      const r = it.raw||{};
      const yesNo = v => v===undefined || v===null ? '‚Äî' : (v ? 'Yes' : 'No');

      const foodOnsite = !!(r.diningonsite || r.diningonsite2);
      const transitOk = (r.transit||'').toLowerCase()==='underhalfamilefromtransit';
      const payMethod = (r.paymentmethod||'').toLowerCase()==='both' ? 'Cash & credit' :
                        (r.paymentmethod||'') ? String(r.paymentmethod) : '‚Äî';

      const rowsSite = [
        ['Hours', r.hours||'‚Äî'],
        ['Cost', it.costText || '‚Äî'],
        ['Duration', it.durationText || '‚Äî'],
        ['Pet-friendly', yesNo(r.dogfriendly)],
        ['Family-friendly', yesNo(r.family_friendly)],
        ['Gift shop', yesNo(r.giftshop)],
        ['Food & beverage on-site', yesNo(foodOnsite)],
        ['Accessible by public transit', yesNo(transitOk)],
        ['ADA accessibility', yesNo(r.adaaccessibility)],
        ['Luggage storage', yesNo(r.luggagestorage)],
        ['Spanish translations', yesNo(r.spanishtranslations)],
        ['Public access', yesNo(r.publicaccess)],
        ['Payment method', payMethod]
      ];

      const rowsTour = [
        ['Duration', it.durationText || '‚Äî'],
        ['# of sites', r.number_of_sites || '‚Äî'],
        ['Cost', r.Cost || r.cost_range?.join(' - ') || '‚Äî'],
        ['Reservation required', yesNo(r.reservation_required)],
        ['Seasonal', yesNo(r.seasonal)],
        ['Group type', r.group_type || '‚Äî']
      ];

      const rows = it.type==='Tour' ? rowsTour : rowsSite;
      const tr = rows.map(([k,v])=>`<tr><th>${k}</th><td>${v}</td></tr>`).join('');
      return `<table class="stats" aria-label="Details"><tbody>${tr}</tbody></table>`;
    }

    /* ---------------- Cards ---------------- */
    function cardHTML(it, score, distMiles, asPopup=false){
      const chips = filterChips(it);
      const chipHtml = chips.map(c=>`<span class="chip">${c}</span>`).join('');
      const metaBits=[]; if(it.categories?.length){ metaBits.push(it.categories.join(', ')); } if(it.periods?.length){ metaBits.push(it.periods[0]); }
      const distanceText = formatMiles(distMiles);
      if(distanceText) metaBits.push(distanceText);
      const img = resolveImage(it.image) || 'images/default.jpg';

      const links = [];
      if(it.website){ links.push(`<a href="${it.website}" target="_blank" rel="noopener">üåê <span>Website</span></a>`); }
      if(it.type==='Tour' && it.raw?.external_links){
        for(const [name,url] of Object.entries(it.raw.external_links)){ links.push(`<a href="${url}" target="_blank" rel="noopener">üîó <span>${name}</span></a>`); }
      }
      const openCard = `<a href="#card-${it.id}" onclick="document.getElementById('closeMap').click(); setTimeout(()=>{document.getElementById('card-${it.id}')?.scrollIntoView({behavior:'smooth',block:'start'});},150); return false;">Open card</a>`;

      const stats = buildStatsTableHTML(it);

      // Trip quick-add UI
      const tripNames = Object.keys(state.trips2.lists);
      const tripSelect = `<select class="select addToTripInline" data-id="${it.id}">${tripNames.map(n=>`<option value="${n}" ${n===state.trips2.current?'selected':''}>${n}</option>`).join('')}</select>
                          <button class="btn addToTripInlineBtn" data-id="${it.id}">Add to Trip</button>`;

      return `
        <article class="card ${asPopup?'popup-card':''}" id="card-${it.id}">
          <span class="badge">${it.type||'Site'}</span>
          <button class="fav${state.favorites.has(it.id)?' active':''}" aria-label="Save" data-id="${it.id}">
            <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.65-7 10-7 10z"/></svg>
          </button>
          <img class="img" src="${img}" alt="${it.name} image" onerror="this.src='images/default.jpg'"/>
          <div class="inner">
            <h3 class="title">${it.name}</h3>
            <div class="meta">${metaBits.join(' ‚Ä¢ ')}</div>
            <div class="chipbar">${chipHtml}</div>
            <details class="more">
              <summary><span>More Info</span></summary>
              <div class="more-body">
                <div class="icons">${[...links, openCard].join(' ')}</div>
                <p class="desc">${it.description||''}</p>
                ${stats}
                <div class="miniRow">${tripSelect}</div>
              </div>
            </details>
          </div>
        </article>`;
    }

    function buildCardNode(it, score, distMiles){
      const tpl = document.getElementById('cardTemplate');
      const node = tpl.content.cloneNode(true);
      const root = node.querySelector('.card');
      root.id = 'card-'+it.id;

      node.querySelector('.badge').textContent = it.type || 'Site';

      const fav = node.querySelector('.fav');
      fav.dataset.id = it.id;
      if(state.favorites.has(it.id)) fav.classList.add('active');
      fav.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFavorite(it.id); });

      const img = node.querySelector('.img');
      const requested = resolveImage(it.image);
      img.src = requested || 'images/default.jpg';
      img.alt = `${it.name} image`;
      img.onerror = ()=>{ img.src = 'images/default.jpg'; };

      node.querySelector('.title').textContent = it.name;

      const metaBits = [];
      if(it.categories?.length){ metaBits.push(it.categories.join(', ')); }
      if(it.periods?.length){ metaBits.push(it.periods[0]); }
      const distanceText = formatMiles(distMiles);
      if(distanceText) metaBits.push(distanceText);
      node.querySelector('.meta').textContent = metaBits.join(' ‚Ä¢ ');

      const chipbar = node.querySelector('.chipbar');
      const chips = filterChips(it);
      chips.forEach(c=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=c; chipbar.appendChild(s); });

      const icons = node.querySelector('.icons');
      const links=[];
      if(it.website){ links.push(`<a href="${it.website}" target="_blank" rel="noopener">üåê <span>Website</span></a>`); }
      if(it.type==='Tour' && it.raw?.external_links){
        for(const [name,url] of Object.entries(it.raw.external_links)){ links.push(`<a href="${url}" target="_blank" rel="noopener">üîó <span>${name}</span></a>`); }
      }
      icons.innerHTML = links.join(' ');
      node.querySelector('.desc').textContent = it.description||'';

      // Stats
      const moreBody = root.querySelector('.more-body');
      const statsDiv = document.createElement('div');
      statsDiv.innerHTML = buildStatsTableHTML(it);
      moreBody.insertBefore(statsDiv.firstElementChild, moreBody.querySelector('.notesBox'));

      // Trip picker in template
      const tripSel = root.querySelector('.addToTripSelect');
      const tripBtn = root.querySelector('.addToTripBtn');
      tripSel.innerHTML = Object.keys(state.trips2.lists).map(n=>`<option value="${n}" ${n===state.trips2.current?'selected':''}>${n}</option>`).join('');
      tripBtn.addEventListener('click', ()=>{
        const trip = tripSel.value;
        addToTrip(it.id, trip);
        alert(`Added to "${trip}".`);
      });

      return node;
    }

    /* ---------------- Favorites + Trips ---------------- */
    function persistTrips(){ localStorage.setItem('traipse:trips2', JSON.stringify(state.trips2)); }
    function currentTrip(){ return state.trips2.current; }
    function currentTripList(){ return state.trips2.lists[currentTrip()] || []; }
    function ensureTrip(name){ if(!state.trips2.lists[name]) state.trips2.lists[name]=[]; }
    function addToTrip(id, tripName){
      ensureTrip(tripName);
      const arr = state.trips2.lists[tripName];
      if(!arr.includes(id)) arr.push(id);
      persistTrips(); renderTripBar(); if(favoritesOpen) renderFavorites();
    }
    function removeFromTrip(id, tripName){
      const arr = state.trips2.lists[tripName]||[];
      state.trips2.lists[tripName] = arr.filter(x=>x!==id);
      persistTrips(); renderTripBar(); if(favoritesOpen) renderFavorites();
    }

    function renderTripBar(){
      const bar = document.getElementById('tripBar');
      const names = Object.keys(state.trips2.lists);
      if(!names.includes('Default')) names.unshift('Default');
      bar.innerHTML = names.map(n=>`<button class="tripPill ${state.trips2.current===n?'active':''}" data-trip="${n}">${n}</button>`).join('');
      bar.querySelectorAll('[data-trip]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          state.trips2.current = btn.getAttribute('data-trip');
          persistTrips(); renderTripBar(); renderFavorites();
          if(document.getElementById('viewTripOnMap').checked){ openMapForCurrentTrip(); }
        });
      });
    }

    function toggleFavorite(id){
      if(state.favorites.has(id)) state.favorites.delete(id); else state.favorites.add(id);
      localStorage.setItem('traipse:favorites', JSON.stringify(Array.from(state.favorites)));
      document.querySelectorAll(`.fav[data-id="${id}"]`).forEach(b=>b.classList.toggle('active', state.favorites.has(id)));
      if(favoritesOpen) renderFavorites();
    }

    function renderFavorites(){
      const host = document.getElementById('favoritesGrid');
      const favItems = state.items.filter(it=>state.favorites.has(it.id));
      const tripSet = new Set(currentTripList());
      const list = favItems
        .map(it => ({it,score:scoreMatches(it),dist:distanceFromUser(it)}))
        .sort((a,b)=> {
          const aIn = tripSet.has(a.it.id), bIn = tripSet.has(b.it.id);
          if(aIn!==bIn) return aIn ? -1 : 1;
          return a.dist-b.dist;
        });
      host.innerHTML='';
      if(!list.length){
        host.innerHTML='<p style="color:#6b7280">No saved places yet. Tap the heart on any card or map popup to save it here.</p>';
        return;
      }
      list.forEach(({it,score,dist})=>{
        const node = buildCardNode(it,score,dist);
        // quick controls
        const mini = document.createElement('div');
        mini.className='miniRow';
        const inTrip = tripSet.has(it.id);
        mini.innerHTML = `
          <select class="select" data-move-sel="${it.id}">
            ${Object.keys(state.trips2.lists).map(n=>`<option value="${n}" ${n===currentTrip()?'selected':''}>${n}</option>`).join('')}
          </select>
          <button class="btn" data-toggle-trip="${it.id}">${inTrip?'Remove from':'Add to'} "${currentTrip()}"</button>
          <button class="btn" data-center-map="${it.id}">View in Map</button>
        `;
        node.querySelector('.more-body').appendChild(mini);

        mini.querySelector(`[data-toggle-trip="${it.id}"]`).addEventListener('click', ()=>{
          if(tripSet.has(it.id)) removeFromTrip(it.id, currentTrip());
          else addToTrip(it.id, currentTrip());
        });
        mini.querySelector(`[data-center-map="${it.id}"]`).addEventListener('click', ()=>{
          ensureMap();
          document.getElementById('favoritesPanel').style.display='none';
          document.getElementById('mapPanel').style.display='block';
          mapOpen=true;
          centerMapOnItem(it.id);
        });
        mini.querySelector(`[data-move-sel="${it.id}"]`).addEventListener('change', (e)=>{
          // move to selected trip
          removeFromTrip(it.id, currentTrip());
          addToTrip(it.id, e.target.value);
          state.trips2.current = e.target.value; persistTrips(); renderTripBar(); renderFavorites();
        });

        host.appendChild(node);
      });
    }

    let favoritesOpen=false;
    document.getElementById('myPlacesLink').addEventListener('click', (e)=>{ e.preventDefault(); favoritesOpen=true; renderTripBar(); renderFavorites(); document.getElementById('favoritesPanel').style.display='block'; });
    document.getElementById('closeFavorites').addEventListener('click', ()=>{ favoritesOpen=false; document.getElementById('favoritesPanel').style.display='none'; });
    document.getElementById('clearFavorites').addEventListener('click', ()=>{
      state.favorites.clear();
      localStorage.setItem('traipse:favorites','[]');
      renderFavorites();
      document.querySelectorAll('.fav').forEach(b=>b.classList.remove('active'));
    });
    document.getElementById('addTripBtn').addEventListener('click', ()=>{
      const name=(document.getElementById('newTripName').value||'').trim(); if(!name) return;
      ensureTrip(name); state.trips2.current=name; persistTrips(); renderTripBar(); renderFavorites();
    });
    document.getElementById('renameTripBtn').addEventListener('click', ()=>{
      const cur=currentTrip(); if(cur==='Default') return alert('Cannot rename Default trip.');
      const name=prompt('New trip name:', cur); if(!name || name===cur) return;
      state.trips2.lists[name]=state.trips2.lists[cur]; delete state.trips2.lists[cur]; state.trips2.current=name;
      persistTrips(); renderTripBar(); renderFavorites();
    });
    document.getElementById('deleteTripBtn').addEventListener('click', ()=>{
      const cur=currentTrip(); if(cur==='Default') return alert('Cannot delete Default trip.');
      if(confirm(`Delete trip "${cur}"?`)){ delete state.trips2.lists[cur]; state.trips2.current='Default'; persistTrips(); renderTripBar(); renderFavorites(); }
    });
    document.getElementById('viewTripOnMap').addEventListener('change', (e)=>{ if(e.target.checked) openMapForCurrentTrip(); });
    document.getElementById('generateItineraryBtn').addEventListener('click', ()=>{
      const arr=currentTripList().slice(); if(!arr.length){ alert('Add some places to the trip first.'); return; }
      let start=null;
      if(state.geoloc) start={lat:state.geoloc.lat,lng:state.geoloc.lng};
      else{
        const it=state.items.find(x=>x.id===arr[0]);
        start = it?.type==='Tour'&&it.center? it.center : (it?.raw?.lat? {lat:it.raw.lat,lng:it.raw.lng}:null);
      }
      if(!start){ alert('Need a location reference to order.'); return; }
      const remaining=arr.slice(); const ordered=[]; let cur=start;
      while(remaining.length){
        let best=0, dist=1e9;
        for(let i=0;i<remaining.length;i++){
          const it=state.items.find(x=>x.id===remaining[i]); let p=null;
          if(it?.type==='Tour'&&it.center) p=it.center; else if(it?.raw?.lat) p={lat:it.raw.lat,lng:it.raw.lng};
          const d=p? haversine(cur,p):1e9; if(d<dist){dist=d; best=i;}
        }
        const next=remaining.splice(best,1)[0]; ordered.push(next);
        const it=state.items.find(x=>x.id===next); cur = it?.type==='Tour'&&it.center? it.center : (it?.raw?.lat? {lat:it.raw.lat,lng:it.raw.lng}:cur);
      }
      state.trips2.lists[currentTrip()]=ordered; persistTrips(); renderFavorites(); if(document.getElementById('viewTripOnMap').checked) openMapForCurrentTrip();
    });

    /* ---------------- Main render ---------------- */
    function passesTab(it){
      if(state.tab==='site') return it.type==='Site';
      if(state.tab==='tour') return it.type==='Tour';
      return true;
    }
    function cityPass(it){
      if(!state.city) return true;
      const c = (it.city||'').toLowerCase();
      return c.includes(state.city);
    }

    function renderCards(){
      const host = document.getElementById('cards');
      const list = state.items.filter(passesTab).filter(cityPass).filter(itemPassesDynamic).map(it=>({
        it,
        score: scoreMatches(it),
        dist: distanceFromUser(it)
      })).sort((a,b)=> b.score-a.score || a.dist-b.dist);

      host.innerHTML='';
      if(!list.length){ host.innerHTML='<p style="color:#6b7280;padding:8px">No results.</p>'; return; }
      list.forEach(({it,score,dist})=> host.appendChild(buildCardNode(it,score,dist)));

      // Wire inline add-to-trip on generated cards
      host.querySelectorAll('.addToTripInlineBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id=btn.getAttribute('data-id');
          const sel = btn.parentElement.querySelector('.addToTripInline');
          addToTrip(id, sel.value);
          alert(`Added to "${sel.value}".`);
        });
      });
    }

    function render(){ renderCards(); if(mapOpen) renderMapPoints(); }

    // Tabs
    document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      state.tab = btn.dataset.tab;
      // rebuild dynamic filters for both panels
      renderDynamicFilters('Main');
      renderDynamicFilters('Map');
      render();
    }));

    // City input
    document.getElementById('cityInput').addEventListener('input', e=>{
      state.city = (e.target.value||'').trim().toLowerCase();
      render();
    });

    /* ---------------- Load data + filters ---------------- */
    async function loadData(){
      try{
        const [siteRes,tourRes] = await Promise.all([
          fetch('locations.json?v='+Date.now()),
          fetch('tours.json?v='+Date.now())
        ]);
        const sites = await siteRes.json();
        const tours = await tourRes.json();

        state.rawSites = Array.isArray(sites)?sites: (sites.locations||[]);
        state.rawTours = Array.isArray(tours)?tours: (tours.tours||[]);

        const siteItems = state.rawSites.map(normalizeSite);
        const tourItems = state.rawTours.map(normalizeTour);
        state.items = [...siteItems, ...tourItems];

        buildFilters('Main');  // original
        buildFilters('Map');   // original
        syncFilterUIs('main');

        // initial dynamic filters
        renderDynamicFilters('Main');
        renderDynamicFilters('Map');

        render();
        locateUser();
      }catch(e){
        document.getElementById('cards').innerHTML = '<p style="color:#6b7280">Failed to load data files.</p>';
        console.error(e);
      }
    }

    /* ---------------- Geolocation ---------------- */
    function locateUser(){
      if(!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        pos => { state.geoloc={lat:pos.coords.latitude, lng:pos.coords.longitude}; render(); },
        () => {}, { enableHighAccuracy:true, timeout:7000, maximumAge:120000 }
      );
    }

    /* ---------------- Map ---------------- */
    let mapOpen=false, map, siteLayer, tourLayer;

    // Cyan-adjusted palette: previously-blue types now cyan
    const TYPE_COLORS = {
      'Museum':'#00cfd4','Landmark':'#f97316','Historical Home':'#059669','Archaeological':'#7c3aed',
      'Religious':'#dc2626','Industrial':'#6b7280','Outdoor':'#16a34a','Burial':'#9ca3af','Political':'#00cfd4'
    };

    function ensureMap(){
      if(map) return;
      map = L.map('map',{scrollWheelZoom:true});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
      siteLayer = L.layerGroup().addTo(map);
      tourLayer = L.layerGroup().addTo(map);
      buildLegend();

      map.on('popupopen', (e)=>{
        const btn = e.popup?.getElement()?.querySelector('.fav[data-id]');
        if(btn){
          btn.addEventListener('click',(ev)=>{ ev.stopPropagation(); toggleFavorite(btn.getAttribute('data-id')); });
        }
        // wire popup trip add buttons
        const addBtn = e.popup?.getElement()?.querySelector('.addToTripInlineBtn');
        if(addBtn){
          addBtn.addEventListener('click', ()=>{
            const id=addBtn.getAttribute('data-id');
            const sel = e.popup.getElement().querySelector('.addToTripInline');
            addToTrip(id, sel.value);
            alert(`Added to "${sel.value}".`);
          });
        }
      });
    }

    function buildLegend(){
      const legend = document.getElementById('mapLegend');
      legend.innerHTML = '<strong>Legend</strong>';
      Object.entries(TYPE_COLORS).forEach(([label,color])=>{
        const row = document.createElement('div');
        row.className='legend-row';
        row.innerHTML = `<span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.12)"></span> <span>${label}</span>`;
        legend.appendChild(row);
      });
      const row = document.createElement('div');
      row.className='legend-row';
      row.innerHTML = `<span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:#e11d48;opacity:.55;border:1px solid #e11d48;"></span> <span>Tour area (size = matches)</span>`;
      legend.appendChild(row);
    }

    function siteIconFor(type){
      const color = TYPE_COLORS[type] || '#00cfd4';
      return L.divIcon({
        className:'circle-icon',
        html:`<div style="width:18px;height:18px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.12)"></div>`,
        iconSize:[22,22], iconAnchor:[11,11]
      });
    }

    function centerMapOnItem(id){
      const it = state.items.find(x=>x.id===id);
      if(!it || !map) return;
      let latlng=null;
      if(it.type==='Site' && typeof it.raw?.lat==='number') latlng=[it.raw.lat,it.raw.lng];
      else if(it.type==='Tour' && it.center) latlng=[it.center.lat,it.center.lng];
      if(latlng){ map.setView(latlng, 15); }
    }

    // When viewing a trip in map, show only items from that trip
    let tripMapMode=false;
    function openMapForCurrentTrip(){
      ensureMap();
      document.getElementById('mapPanel').style.display='block';
      mapOpen=true; tripMapMode=true;
      renderMapPoints();
    }

    function renderMapPoints(){
      if(!map) return;
      siteLayer.clearLayers();
      tourLayer.clearLayers();

      const base = state.items.filter(passesTab).filter(cityPass).filter(itemPassesDynamic);
      const list = tripMapMode ? base.filter(it=>currentTripList().includes(it.id)) : base;

      const sites = list.filter(it=>it.type==='Site');
      const tours = list.filter(it=>it.type==='Tour');

      const bounds=[];

      sites.forEach(it=>{
        const {lat,lng} = it.raw||{};
        if(typeof lat==='number' && typeof lng==='number'){
          const m = L.marker([lat,lng],{icon:siteIconFor(it.siteType)}).addTo(siteLayer);
          const html = cardHTML(it, scoreMatches(it), distanceFromUser(it), true);
          m.bindPopup(html);
          bounds.push([lat,lng]);
        }
      });

      tours.forEach(it=>{
        if(it.center){
          const s = scoreMatches(it);
          const radius = 250 + 200 * s; // meters
          const circle = L.circle(it.center, {
            color:'#e11d48',
            fillColor:'#e11d48',
            fillOpacity:0.45,
            weight:1,
            radius
          }).addTo(tourLayer);
          const html = cardHTML(it, s, distanceFromUser(it), true);
          circle.bindPopup(html);
          bounds.push([it.center.lat, it.center.lng]);
        }
      });

      if(bounds.length){ map.fitBounds(bounds,{padding:[30,30]}); }
      else{ map.setView([39.7392,-104.9903], 11); }

      setTimeout(()=>map.invalidateSize(), 60);
    }

    document.getElementById('viewMap').addEventListener('click', ()=>{
      ensureMap();
      document.getElementById('mapPanel').style.display='block';
      mapOpen=true; tripMapMode=false;
      syncFilterUIs('main');  // mirror current main filters into map panel on open
      renderMapPoints();
    });
    document.getElementById('closeMap').addEventListener('click', ()=>{
      document.getElementById('mapPanel').style.display='none';
      mapOpen=false; tripMapMode=false;
    });
    document.getElementById('mapShowAll').addEventListener('click', ()=>{
      if(!map) return;
      // clear dynamic and legacy filters temporarily
      const backup = {
        siteTypes:new Set(state.filters.siteTypes),
        periods:new Set(state.filters.periods),
        tags:new Set(state.filters.tags),
        dynamic: JSON.parse(JSON.stringify({
          category:Array.from(state.dynamic.category||[]),
          duration:Array.from(state.dynamic.duration||[]),
          cost:Array.from(state.dynamic.cost||[]),
          estTime:Array.from(state.dynamic.estTime||[]),
          pet:state.dynamic.pet,fam:state.dynamic.fam,gift:state.dynamic.gift,food:state.dynamic.food,
          transit:state.dynamic.transit,ada:state.dynamic.ada,span:state.dynamic.span,payment:state.dynamic.payment,
          luggage:state.dynamic.luggage,hidden:state.dynamic.hidden,featured:state.dynamic.featured,public:state.dynamic.public,
          timeOfDay:Array.from(state.dynamic.timeOfDay||[]),groupSize:Array.from(state.dynamic.groupSize||[]),walkDistance:Array.from(state.dynamic.walkDistance||[]),
          reservation:state.dynamic.reservation
        }))
      };
      state.filters.siteTypes.clear(); state.filters.periods.clear(); state.filters.tags.clear();
      state.dynamic={category:new Set(), duration:new Set(), cost:new Set(), estTime:new Set(),
        pet:false,fam:false,gift:false,food:false,transit:false,ada:false,span:false,payment:'',luggage:false,hidden:false,featured:false,public:false,
        timeOfDay:new Set(),groupSize:new Set(),walkDistance:new Set(),reservation:'any'};
      tripMapMode=false;
      renderDynamicFilters('Main'); renderDynamicFilters('Map'); renderMapPoints();
      // restore
      state.filters.siteTypes=backup.siteTypes; state.filters.periods=backup.periods; state.filters.tags=backup.tags;
      // rebuild dynamic sets from arrays
      const d=backup.dynamic;
      state.dynamic.category=new Set(d.category); state.dynamic.duration=new Set(d.duration); state.dynamic.cost=new Set(d.cost); state.dynamic.estTime=new Set(d.estTime);
      state.dynamic.timeOfDay=new Set(d.timeOfDay); state.dynamic.groupSize=new Set(d.groupSize); state.dynamic.walkDistance=new Set(d.walkDistance);
      state.dynamic.pet=d.pet; state.dynamic.fam=d.fam; state.dynamic.gift=d.gift; state.dynamic.food=d.food; state.dynamic.transit=d.transit; state.dynamic.ada=d.ada; state.dynamic.span=d.span;
      state.dynamic.payment=d.payment; state.dynamic.luggage=d.luggage; state.dynamic.hidden=d.hidden; state.dynamic.featured=d.featured; state.dynamic.public=d.public;
      state.dynamic.reservation=d.reservation;
      renderDynamicFilters('Main'); renderDynamicFilters('Map');
    });

    /* ---------------- OUR DATA pill rename (kept) ---------------- */
    (function(){
      const navPills = document.querySelectorAll('nav.links .pill');
      if(navPills && navPills[1]){
        const ourDataLink = navPills[1];
        ourDataLink.textContent = 'OUR DATA';
        ourDataLink.id = 'ourDataLink';
        ourDataLink.setAttribute('aria-haspopup', 'dialog');
        ourDataLink.addEventListener('click', (e)=>{
          e.preventDefault();
          const panel = document.getElementById('ourDataPanel');
          if(panel){ panel.style.display = 'block'; panel.setAttribute('aria-hidden','false'); }
        });
      }
      const closeOurData = document.getElementById('closeOurData');
      if(closeOurData){
        closeOurData.addEventListener('click', ()=>{
          const panel = document.getElementById('ourDataPanel');
          if(panel){ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); }
        });
      }
      const suggestEditBtn = document.getElementById('suggestEditBtn');
      if(suggestEditBtn){
        suggestEditBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          alert('Suggest an Edit: wire this up to your form or route.');
        });
      }
      const newSiteBtn = document.getElementById('newSiteBtn');
      if(newSiteBtn){
        newSiteBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          alert('New Site Submission: wire this up to your form or route.');
        });
      }
    })();

    /* ---------------- Kickoff ---------------- */
    loadData();

  </script>
</body>
</html>
